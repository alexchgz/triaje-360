/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, NgZone } from '@angular/core';
import { Observable } from 'rxjs';
import { YaMapsAPILoader } from './services/ya-maps-loader';
import { DocumentRef } from './utils/browser-globals';
var YaMapsAPIWrapper = /** @class */ (function () {
    function YaMapsAPIWrapper(_loader, _zone, d) {
        var _this = this;
        this._loader = _loader;
        this._zone = _zone;
        this._documentRef = d;
        this._map = new Promise(function (resolve) {
            _this._mapResolver = resolve;
        });
    }
    /**
     * @param {?} el
     * @param {?} mapOptions
     * @return {?}
     */
    YaMapsAPIWrapper.prototype.createMap = /**
     * @param {?} el
     * @param {?} mapOptions
     * @return {?}
     */
    function (el, mapOptions) {
        var _this = this;
        /** @type {?} */
        var res = this._loader.load().then(function () {
            /** @type {?} */
            var create = function () { return setTimeout(function () {
                if (ymaps.Map) {
                    /** @type {?} */
                    var map = new ymaps.Map(el, mapOptions);
                    _this._mapResolver((/** @type {?} */ (map)));
                }
                else {
                    create();
                }
            }, 100); };
            create();
        }).catch(function (e) { return console.log(e); });
        return res;
    };
    /**
     * @param {?} latitude
     * @param {?} longitude
     * @return {?}
     */
    YaMapsAPIWrapper.prototype.setCenter = /**
     * @param {?} latitude
     * @param {?} longitude
     * @return {?}
     */
    function (latitude, longitude) {
        this._map.then(function (map) {
            map.setCenter([latitude, longitude]);
        });
    };
    /**
     * @return {?}
     */
    YaMapsAPIWrapper.prototype.getCenter = /**
     * @return {?}
     */
    function () {
        return this._map.then(function (map) {
            return map.getCenter();
        });
    };
    /**
     * @param {?} points
     * @param {?} options
     * @return {?}
     */
    YaMapsAPIWrapper.prototype.panTo = /**
     * @param {?} points
     * @param {?} options
     * @return {?}
     */
    function (points, options) {
        this._map.then(function (map) {
            map.panTo(points, options);
        });
    };
    /**
     * @template E
     * @param {?} eventName
     * @return {?}
     */
    YaMapsAPIWrapper.prototype.subscribeToMapEvent = /**
     * @template E
     * @param {?} eventName
     * @return {?}
     */
    function (eventName) {
        var _this = this;
        return Observable.create(function (observer) {
            _this._map.then(function (m) {
                m.events.add(eventName, function (arg) { _this._zone.run(function () { return observer.next(arg); }); });
            });
        });
    };
    /**
     * @param {?} marker
     * @return {?}
     */
    YaMapsAPIWrapper.prototype.createMarker = /**
     * @param {?} marker
     * @return {?}
     */
    function (marker) {
        return this._map.then(function (map) {
            /** @type {?} */
            var m = new ymaps.Placemark([marker.latitude, marker.longitude], {
                balloonContentHeader: marker.balloonContentHeader,
                balloonContentBody: marker.balloonContentBody,
                balloonContentFooter: marker.balloonContentFooter,
                iconContent: marker.iconContent
            }, {
                draggable: marker.draggable,
                preset: marker.preset,
                iconLayout: marker.iconLayout,
                iconImageHref: marker.iconImageHref,
                iconImageSize: marker.iconImageSize,
                iconImageOffset: marker.iconImageOffset
            });
            map.geoObjects.add(m);
            return m;
        });
    };
    /**
     * @param {?} overlay
     * @return {?}
     */
    YaMapsAPIWrapper.prototype.removeGeo = /**
     * @param {?} overlay
     * @return {?}
     */
    function (overlay) {
        this._map.then(function (map) {
            map.geoObjects.remove(overlay);
        });
    };
    /**
     * @param {?} claster
     * @return {?}
     */
    YaMapsAPIWrapper.prototype.createClaster = /**
     * @param {?} claster
     * @return {?}
     */
    function (claster) {
        return this._map.then(function (map) {
            if (claster.markers.length === 0) {
                return;
            }
            /** @type {?} */
            var myGeoObjects;
            myGeoObjects = new Array();
            claster.markers.forEach(function (x) {
                /** @type {?} */
                var point = new ymaps.GeoObject({
                    geometry: { type: x.type, coordinates: [x.lat, x.lng] }
                });
                myGeoObjects.push(point);
            });
            /** @type {?} */
            var clusterer = new ymaps.Clusterer({});
            clusterer.add(myGeoObjects);
            map.geoObjects.add(clusterer);
            return clusterer;
        });
    };
    /**
     * @param {?} objectManager
     * @return {?}
     */
    YaMapsAPIWrapper.prototype.createObjectManager = /**
     * @param {?} objectManager
     * @return {?}
     */
    function (objectManager) {
        return this._map.then(function (map) {
            if (objectManager.datasource.length === 0) {
                return;
            }
            /** @type {?} */
            var nativeObjectManager = new ymaps.ObjectManager({
                clusterize: objectManager.clusterize,
                gridSize: objectManager.gridSize
            });
            nativeObjectManager.add(objectManager.datasource);
            nativeObjectManager.objects.options.set('preset', objectManager.objectPreset);
            nativeObjectManager.clusters.options.set('preset', objectManager.clasterPreset);
            map.geoObjects.add(nativeObjectManager);
            return nativeObjectManager;
        });
    };
    /**
     * @param {?} objectManager
     * @param {?} id
     * @return {?}
     */
    YaMapsAPIWrapper.prototype.navigateToGeoObject = /**
     * @param {?} objectManager
     * @param {?} id
     * @return {?}
     */
    function (objectManager, id) {
        /** @type {?} */
        var obj = objectManager.objects.getById(id);
        if (obj) {
            this.setCenter(obj.geometry.coordinates[0], obj.geometry.coordinates[1]);
            objectManager.objects.balloon.open(id);
        }
    };
    /**
     * @return {?}
     */
    YaMapsAPIWrapper.prototype.checkYaSciptLoaded = /**
     * @return {?}
     */
    function () {
        return this._documentRef.getNativeDocument().getElementById('YaScript');
    };
    /**
     * @param {?} objectManager
     * @param {?} filter
     * @return {?}
     */
    YaMapsAPIWrapper.prototype.objectManagerSetFilter = /**
     * @param {?} objectManager
     * @param {?} filter
     * @return {?}
     */
    function (objectManager, filter) {
        objectManager.setFilter(filter);
    };
    YaMapsAPIWrapper.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    YaMapsAPIWrapper.ctorParameters = function () { return [
        { type: YaMapsAPILoader },
        { type: NgZone },
        { type: DocumentRef }
    ]; };
    return YaMapsAPIWrapper;
}());
export { YaMapsAPIWrapper };
if (false) {
    /**
     * @type {?}
     * @private
     */
    YaMapsAPIWrapper.prototype._map;
    /**
     * @type {?}
     * @private
     */
    YaMapsAPIWrapper.prototype._mapResolver;
    /**
     * @type {?}
     * @private
     */
    YaMapsAPIWrapper.prototype._documentRef;
    /**
     * @type {?}
     * @private
     */
    YaMapsAPIWrapper.prototype._loader;
    /**
     * @type {?}
     * @private
     */
    YaMapsAPIWrapper.prototype._zone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieWEtbWFwcy1hcGktd3JhcHBlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL3lhbWFwbmcvIiwic291cmNlcyI6WyJsaWIveWEtbWFwcy1hcGktd3JhcHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUlsQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFJNUQsT0FBTyxFQUFFLFdBQVcsRUFBYSxNQUFNLHlCQUF5QixDQUFDO0FBSWpFO0lBTUksMEJBQW9CLE9BQXdCLEVBQVUsS0FBYSxFQUFFLENBQWM7UUFBbkYsaUJBS0M7UUFMbUIsWUFBTyxHQUFQLE9BQU8sQ0FBaUI7UUFBVSxVQUFLLEdBQUwsS0FBSyxDQUFRO1FBQy9ELElBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxPQUFPLENBQXFCLFVBQUMsT0FBbUI7WUFDNUQsS0FBSSxDQUFDLFlBQVksR0FBRyxPQUFPLENBQUM7UUFDaEMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDOzs7Ozs7SUFFTSxvQ0FBUzs7Ozs7SUFBaEIsVUFBaUIsRUFBZSxFQUFFLFVBQStCO1FBQWpFLGlCQWFDOztZQVpTLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQzs7Z0JBQzNCLE1BQU0sR0FBRyxjQUFNLE9BQUEsVUFBVSxDQUFDO2dCQUM1QixJQUFJLEtBQUssQ0FBQyxHQUFHLEVBQUU7O3dCQUNMLEdBQUcsR0FBRyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLFVBQVUsQ0FBQztvQkFDekMsS0FBSSxDQUFDLFlBQVksQ0FBQyxtQkFBQSxHQUFHLEVBQXNCLENBQUMsQ0FBQztpQkFDaEQ7cUJB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Ozs7OztJQUE3QixVQUE4QixhQUFrQixFQUFFLE1BQVc7UUFDekQsYUFBYSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNwQyxDQUFDOztnQkE1SUosVUFBVTs7OztnQkFSRixlQUFlO2dCQUxILE1BQU07Z0JBU2xCLFdBQVc7O0lBa0pwQix1QkFBQztDQUFBLEFBOUlELElBOElDO1NBN0lZLGdCQUFnQjs7Ozs7O0lBQ3pCLGdDQUEwQzs7Ozs7SUFDMUMsd0NBQTJEOzs7OztJQUMzRCx3Q0FBa0M7Ozs7O0lBRXRCLG1DQUFnQzs7Ozs7SUFBRSxpQ0FBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IE9ic2VydmVyIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCAqIGFzIG1hcFR5cGVzIGZyb20gJy4veWEtbWFwcy10eXBlcyc7XG5pbXBvcnQgeyBZYU1hcHNBUElMb2FkZXIgfSBmcm9tICcuL3NlcnZpY2VzL3lhLW1hcHMtbG9hZGVyJztcbmltcG9ydCB7IFlhTWFya2VyIH0gZnJvbSAnLi9kaXJlY3RpdmVzL21hcmtlcic7XG5pbXBvcnQgeyBZYUNsYXN0ZXIgfSBmcm9tICcuL2RpcmVjdGl2ZXMvY2xhc3Rlcic7XG5pbXBvcnQgeyBZYU9iamVjdE1hbmFnZXIgfSBmcm9tICcuL2RpcmVjdGl2ZXMvb2JqZWN0TWFuYWdlcic7XG5pbXBvcnQgeyBEb2N1bWVudFJlZiwgV2luZG93UmVmIH0gZnJvbSAnLi91dGlscy9icm93c2VyLWdsb2JhbHMnO1xuXG5kZWNsYXJlIHZhciB5bWFwczogYW55O1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgWWFNYXBzQVBJV3JhcHBlciB7XG4gICAgcHJpdmF0ZSBfbWFwOiBQcm9taXNlPG1hcFR5cGVzLllhbmRleE1hcD47XG4gICAgcHJpdmF0ZSBfbWFwUmVzb2x2ZXI6ICh2YWx1ZT86IG1hcFR5cGVzLllhbmRleE1hcCkgPT4gdm9pZDtcbiAgICBwcml2YXRlIF9kb2N1bWVudFJlZjogRG9jdW1lbnRSZWY7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9sb2FkZXI6IFlhTWFwc0FQSUxvYWRlciwgcHJpdmF0ZSBfem9uZTogTmdab25lLCBkOiBEb2N1bWVudFJlZikge1xuICAgICAgICB0aGlzLl9kb2N1bWVudFJlZiA9IGQ7XG4gICAgICAgIHRoaXMuX21hcCA9IG5ldyBQcm9taXNlPG1hcFR5cGVzLllhbmRleE1hcD4oKHJlc29sdmU6ICgpID0+IHZvaWQpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX21hcFJlc29sdmVyID0gcmVzb2x2ZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZU1hcChlbDogSFRNTEVsZW1lbnQsIG1hcE9wdGlvbnM6IG1hcFR5cGVzLk1hcE9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgcmVzID0gdGhpcy5fbG9hZGVyLmxvYWQoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNyZWF0ZSA9ICgpID0+IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh5bWFwcy5NYXApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWFwID0gbmV3IHltYXBzLk1hcChlbCwgbWFwT3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX21hcFJlc29sdmVyKG1hcCBhcyBtYXBUeXBlcy5ZYW5kZXhNYXApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNyZWF0ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIDEwMCk7XG4gICAgICAgICAgICBjcmVhdGUoKTtcbiAgICAgICAgfSkuY2F0Y2goKGUpID0+IGNvbnNvbGUubG9nKGUpKTtcbiAgICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0Q2VudGVyKGxhdGl0dWRlOiBudW1iZXIsIGxvbmdpdHVkZTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMuX21hcC50aGVuKChtYXA6IG1hcFR5cGVzLllhbmRleE1hcCkgPT4ge1xuICAgICAgICAgICAgbWFwLnNldENlbnRlcihbbGF0aXR1ZGUsIGxvbmdpdHVkZV0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q2VudGVyKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fbWFwLnRoZW4oKG1hcDogbWFwVHlwZXMuWWFuZGV4TWFwKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbWFwLmdldENlbnRlcigpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcGFuVG8ocG9pbnRzOiBhbnlbXSwgb3B0aW9uczogYW55W10pIHtcbiAgICAgICAgdGhpcy5fbWFwLnRoZW4oKG1hcDogbWFwVHlwZXMuWWFuZGV4TWFwKSA9PiB7XG4gICAgICAgICAgICBtYXAucGFuVG8ocG9pbnRzLCBvcHRpb25zKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIHN1YnNjcmliZVRvTWFwRXZlbnQ8RT4oZXZlbnROYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEU+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogT2JzZXJ2ZXI8RT4pID0+IHtcbiAgICAgICAgICAgIHRoaXMuX21hcC50aGVuKChtOiBtYXBUeXBlcy5ZYW5kZXhNYXApID0+IHtcbiAgICAgICAgICAgICAgICBtLmV2ZW50cy5hZGQoZXZlbnROYW1lLCAoYXJnOiBFKSA9PiB7IHRoaXMuX3pvbmUucnVuKCgpID0+IG9ic2VydmVyLm5leHQoYXJnKSk7IH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBjcmVhdGVNYXJrZXIobWFya2VyOiBZYU1hcmtlcik6IFByb21pc2U8bWFwVHlwZXMuTWFya2VyPiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9tYXAudGhlbigobWFwOiBtYXBUeXBlcy5ZYW5kZXhNYXApID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG0gPSBuZXcgeW1hcHMuUGxhY2VtYXJrKFttYXJrZXIubGF0aXR1ZGUsIG1hcmtlci5sb25naXR1ZGVdLCB7XG4gICAgICAgICAgICAgICAgYmFsbG9vbkNvbnRlbnRIZWFkZXI6IG1hcmtlci5iYWxsb29uQ29udGVudEhlYWRlcixcbiAgICAgICAgICAgICAgICBiYWxsb29uQ29udGVudEJvZHk6IG1hcmtlci5iYWxsb29uQ29udGVudEJvZHksXG4gICAgICAgICAgICAgICAgYmFsbG9vbkNvbnRlbnRGb290ZXI6IG1hcmtlci5iYWxsb29uQ29udGVudEZvb3RlcixcbiAgICAgICAgICAgICAgICBpY29uQ29udGVudDogbWFya2VyLmljb25Db250ZW50XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgZHJhZ2dhYmxlOiBtYXJrZXIuZHJhZ2dhYmxlLFxuICAgICAgICAgICAgICAgICAgICBwcmVzZXQ6IG1hcmtlci5wcmVzZXQsXG4gICAgICAgICAgICAgICAgICAgIGljb25MYXlvdXQ6IG1hcmtlci5pY29uTGF5b3V0LFxuICAgICAgICAgICAgICAgICAgICBpY29uSW1hZ2VIcmVmOiBtYXJrZXIuaWNvbkltYWdlSHJlZixcbiAgICAgICAgICAgICAgICAgICAgaWNvbkltYWdlU2l6ZTogbWFya2VyLmljb25JbWFnZVNpemUsXG4gICAgICAgICAgICAgICAgICAgIGljb25JbWFnZU9mZnNldDogbWFya2VyLmljb25JbWFnZU9mZnNldFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgbWFwLmdlb09iamVjdHMuYWRkKG0pO1xuICAgICAgICAgICAgcmV0dXJuIG07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyByZW1vdmVHZW8ob3ZlcmxheTogYW55KSB7XG4gICAgICAgIHRoaXMuX21hcC50aGVuKChtYXA6IG1hcFR5cGVzLllhbmRleE1hcCkgPT4ge1xuICAgICAgICAgICAgbWFwLmdlb09iamVjdHMucmVtb3ZlKG92ZXJsYXkpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY3JlYXRlQ2xhc3RlcihjbGFzdGVyOiBZYUNsYXN0ZXIpOiBQcm9taXNlPG1hcFR5cGVzLkNsYXN0ZXI+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX21hcC50aGVuKChtYXA6IG1hcFR5cGVzLllhbmRleE1hcCkgPT4ge1xuICAgICAgICAgICAgaWYgKGNsYXN0ZXIubWFya2Vycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBteUdlb09iamVjdHM6IGFueVtdO1xuICAgICAgICAgICAgbXlHZW9PYmplY3RzID0gbmV3IEFycmF5PGFueT4oKTtcbiAgICAgICAgICAgIGNsYXN0ZXIubWFya2Vycy5mb3JFYWNoKCh4OiBtYXBUeXBlcy5NYXJrZXJDbGFzdGVyKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcG9pbnQgPSBuZXcgeW1hcHMuR2VvT2JqZWN0KHtcbiAgICAgICAgICAgICAgICAgICAgZ2VvbWV0cnk6IHsgdHlwZTogeC50eXBlLCBjb29yZGluYXRlczogW3gubGF0LCB4LmxuZ10gfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIG15R2VvT2JqZWN0cy5wdXNoKHBvaW50KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjb25zdCBjbHVzdGVyZXIgPSBuZXcgeW1hcHMuQ2x1c3RlcmVyKHt9KTtcbiAgICAgICAgICAgIGNsdXN0ZXJlci5hZGQobXlHZW9PYmplY3RzKTtcbiAgICAgICAgICAgIG1hcC5nZW9PYmplY3RzLmFkZChjbHVzdGVyZXIpO1xuXG4gICAgICAgICAgICByZXR1cm4gY2x1c3RlcmVyO1xuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBjcmVhdGVPYmplY3RNYW5hZ2VyKG9iamVjdE1hbmFnZXI6IFlhT2JqZWN0TWFuYWdlcik6IGFueSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9tYXAudGhlbigobWFwOiBtYXBUeXBlcy5ZYW5kZXhNYXApID0+IHtcblxuICAgICAgICAgICAgaWYgKG9iamVjdE1hbmFnZXIuZGF0YXNvdXJjZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IG5hdGl2ZU9iamVjdE1hbmFnZXIgPSBuZXcgeW1hcHMuT2JqZWN0TWFuYWdlcih7XG4gICAgICAgICAgICAgICAgY2x1c3Rlcml6ZTogb2JqZWN0TWFuYWdlci5jbHVzdGVyaXplLFxuICAgICAgICAgICAgICAgIGdyaWRTaXplOiBvYmplY3RNYW5hZ2VyLmdyaWRTaXplXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbmF0aXZlT2JqZWN0TWFuYWdlci5hZGQob2JqZWN0TWFuYWdlci5kYXRhc291cmNlKTtcblxuICAgICAgICAgICAgbmF0aXZlT2JqZWN0TWFuYWdlci5vYmplY3RzLm9wdGlvbnMuc2V0KCdwcmVzZXQnLCBvYmplY3RNYW5hZ2VyLm9iamVjdFByZXNldCk7XG4gICAgICAgICAgICBuYXRpdmVPYmplY3RNYW5hZ2VyLmNsdXN0ZXJzLm9wdGlvbnMuc2V0KCdwcmVzZXQnLCBvYmplY3RNYW5hZ2VyLmNsYXN0ZXJQcmVzZXQpO1xuICAgICAgICAgICAgbWFwLmdlb09iamVjdHMuYWRkKG5hdGl2ZU9iamVjdE1hbmFnZXIpO1xuICAgICAgICAgICAgcmV0dXJuIG5hdGl2ZU9iamVjdE1hbmFnZXI7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBuYXZpZ2F0ZVRvR2VvT2JqZWN0KG9iamVjdE1hbmFnZXI6IGFueSwgaWQ6IGFueSkge1xuICAgICAgICBjb25zdCBvYmogPSBvYmplY3RNYW5hZ2VyLm9iamVjdHMuZ2V0QnlJZChpZCk7XG4gICAgICAgIGlmIChvYmopIHtcbiAgICAgICAgICAgIHRoaXMuc2V0Q2VudGVyKG9iai5nZW9tZXRyeS5jb29yZGluYXRlc1swXSwgb2JqLmdlb21ldHJ5LmNvb3JkaW5hdGVzWzFdKTtcbiAgICAgICAgICAgIG9iamVjdE1hbmFnZXIub2JqZWN0cy5iYWxsb29uLm9wZW4oaWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGNoZWNrWWFTY2lwdExvYWRlZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RvY3VtZW50UmVmLmdldE5hdGl2ZURvY3VtZW50KCkuZ2V0RWxlbWVudEJ5SWQoJ1lhU2NyaXB0Jyk7XG4gICAgfVxuXG4gICAgcHVibGljIG9iamVjdE1hbmFnZXJTZXRGaWx0ZXIob2JqZWN0TWFuYWdlcjogYW55LCBmaWx0ZXI6IGFueSkge1xuICAgICAgICBvYmplY3RNYW5hZ2VyLnNldEZpbHRlcihmaWx0ZXIpO1xuICAgIH1cblxufVxuIl19