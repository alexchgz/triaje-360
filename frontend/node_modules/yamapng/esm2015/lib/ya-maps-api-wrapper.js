/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, NgZone } from '@angular/core';
import { Observable } from 'rxjs';
import { YaMapsAPILoader } from './services/ya-maps-loader';
import { DocumentRef } from './utils/browser-globals';
export class YaMapsAPIWrapper {
    /**
     * @param {?} _loader
     * @param {?} _zone
     * @param {?} d
     */
    constructor(_loader, _zone, d) {
        this._loader = _loader;
        this._zone = _zone;
        this._documentRef = d;
        this._map = new Promise((resolve) => {
            this._mapResolver = resolve;
        });
    }
    /**
     * @param {?} el
     * @param {?} mapOptions
     * @return {?}
     */
    createMap(el, mapOptions) {
        /** @type {?} */
        const res = this._loader.load().then(() => {
            /** @type {?} */
            const create = () => setTimeout(() => {
                if (ymaps.Map) {
                    /** @type {?} */
                    const map = new ymaps.Map(el, mapOptions);
                    this._mapResolver((/** @type {?} */ (map)));
                }
                else {
                    create();
                }
            }, 100);
            create();
        }).catch((e) => console.log(e));
        return res;
    }
    /**
     * @param {?} latitude
     * @param {?} longitude
     * @return {?}
     */
    setCenter(latitude, longitude) {
        this._map.then((map) => {
            map.setCenter([latitude, longitude]);
        });
    }
    /**
     * @return {?}
     */
    getCenter() {
        return this._map.then((map) => {
            return map.getCenter();
        });
    }
    /**
     * @param {?} points
     * @param {?} options
     * @return {?}
     */
    panTo(points, options) {
        this._map.then((map) => {
            map.panTo(points, options);
        });
    }
    /**
     * @template E
     * @param {?} eventName
     * @return {?}
     */
    subscribeToMapEvent(eventName) {
        return Observable.create((observer) => {
            this._map.then((m) => {
                m.events.add(eventName, (arg) => { this._zone.run(() => observer.next(arg)); });
            });
        });
    }
    /**
     * @param {?} marker
     * @return {?}
     */
    createMarker(marker) {
        return this._map.then((map) => {
            /** @type {?} */
            const m = new ymaps.Placemark([marker.latitude, marker.longitude], {
                balloonContentHeader: marker.balloonContentHeader,
                balloonContentBody: marker.balloonContentBody,
                balloonContentFooter: marker.balloonContentFooter,
                iconContent: marker.iconContent
            }, {
                draggable: marker.draggable,
                preset: marker.preset,
                iconLayout: marker.iconLayout,
                iconImageHref: marker.iconImageHref,
                iconImageSize: marker.iconImageSize,
                iconImageOffset: marker.iconImageOffset
            });
            map.geoObjects.add(m);
            return m;
        });
    }
    /**
     * @param {?} overlay
     * @return {?}
     */
    removeGeo(overlay) {
        this._map.then((map) => {
            map.geoObjects.remove(overlay);
        });
    }
    /**
     * @param {?} claster
     * @return {?}
     */
    createClaster(claster) {
        return this._map.then((map) => {
            if (claster.markers.length === 0) {
                return;
            }
            /** @type {?} */
            let myGeoObjects;
            myGeoObjects = new Array();
            claster.markers.forEach((x) => {
                /** @type {?} */
                const point = new ymaps.GeoObject({
                    geometry: { type: x.type, coordinates: [x.lat, x.lng] }
                });
                myGeoObjects.push(point);
            });
            /** @type {?} */
            const clusterer = new ymaps.Clusterer({});
            clusterer.add(myGeoObjects);
            map.geoObjects.add(clusterer);
            return clusterer;
        });
    }
    /**
     * @param {?} objectManager
     * @return {?}
     */
    createObjectManager(objectManager) {
        return this._map.then((map) => {
            if (objectManager.datasource.length === 0) {
                return;
            }
            /** @type {?} */
            const nativeObjectManager = new ymaps.ObjectManager({
                clusterize: objectManager.clusterize,
                gridSize: objectManager.gridSize
            });
            nativeObjectManager.add(objectManager.datasource);
            nativeObjectManager.objects.options.set('preset', objectManager.objectPreset);
            nativeObjectManager.clusters.options.set('preset', objectManager.clasterPreset);
            map.geoObjects.add(nativeObjectManager);
            return nativeObjectManager;
        });
    }
    /**
     * @param {?} objectManager
     * @param {?} id
     * @return {?}
     */
    navigateToGeoObject(objectManager, id) {
        /** @type {?} */
        const obj = objectManager.objects.getById(id);
        if (obj) {
            this.setCenter(obj.geometry.coordinates[0], obj.geometry.coordinates[1]);
            objectManager.objects.balloon.open(id);
        }
    }
    /**
     * @return {?}
     */
    checkYaSciptLoaded() {
        return this._documentRef.getNativeDocument().getElementById('YaScript');
    }
    /**
     * @param {?} objectManager
     * @param {?} filter
     * @return {?}
     */
    objectManagerSetFilter(objectManager, filter) {
        objectManager.setFilter(filter);
    }
}
YaMapsAPIWrapper.decorators = [
    { type: Injectable }
];
/** @nocollapse */
YaMapsAPIWrapper.ctorParameters = () => [
    { type: YaMapsAPILoader },
    { type: NgZone },
    { type: DocumentRef }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    YaMapsAPIWrapper.prototype._map;
    /**
     * @type {?}
     * @private
     */
    YaMapsAPIWrapper.prototype._mapResolver;
    /**
     * @type {?}
     * @private
     */
    YaMapsAPIWrapper.prototype._documentRef;
    /**
     * @type {?}
     * @private
     */
    YaMapsAPIWrapper.prototype._loader;
    /**
     * @type {?}
     * @private
     */
    YaMapsAPIWrapper.prototype._zone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieWEtbWFwcy1hcGktd3JhcHBlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL3lhbWFwbmcvIiwic291cmNlcyI6WyJsaWIveWEtbWFwcy1hcGktd3JhcHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUlsQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFJNUQsT0FBTyxFQUFFLFdBQVcsRUFBYSxNQUFNLHlCQUF5QixDQUFDO0FBS2pFLE1BQU0sT0FBTyxnQkFBZ0I7Ozs7OztJQUt6QixZQUFvQixPQUF3QixFQUFVLEtBQWEsRUFBRSxDQUFjO1FBQS9ELFlBQU8sR0FBUCxPQUFPLENBQWlCO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUMvRCxJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksT0FBTyxDQUFxQixDQUFDLE9BQW1CLEVBQUUsRUFBRTtZQUNoRSxJQUFJLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQztRQUNoQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Ozs7OztJQUVNLFNBQVMsQ0FBQyxFQUFlLEVBQUUsVUFBK0I7O2NBQ3ZELEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7O2tCQUNoQyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRTtnQkFDakMsSUFBSSxLQUFLLENBQUMsR0FBRyxFQUFFOzswQkFDTCxHQUFHLEdBQUcsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxVQUFVLENBQUM7b0JBQ3pDLElBQUksQ0FBQyxZQUFZLENBQUMsbUJBQUEsR0FBRyxFQUFz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QyxhQUFrQixFQUFFLE1BQVc7UUFDekQsYUFBYSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNwQyxDQUFDOzs7WUE1SUosVUFBVTs7OztZQVJGLGVBQWU7WUFMSCxNQUFNO1lBU2xCLFdBQVc7Ozs7Ozs7SUFNaEIsZ0NBQTBDOzs7OztJQUMxQyx3Q0FBMkQ7Ozs7O0lBQzNELHdDQUFrQzs7Ozs7SUFFdEIsbUNBQWdDOzs7OztJQUFFLGlDQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgT2JzZXJ2ZXIgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0ICogYXMgbWFwVHlwZXMgZnJvbSAnLi95YS1tYXBzLXR5cGVzJztcbmltcG9ydCB7IFlhTWFwc0FQSUxvYWRlciB9IGZyb20gJy4vc2VydmljZXMveWEtbWFwcy1sb2FkZXInO1xuaW1wb3J0IHsgWWFNYXJrZXIgfSBmcm9tICcuL2RpcmVjdGl2ZXMvbWFya2VyJztcbmltcG9ydCB7IFlhQ2xhc3RlciB9IGZyb20gJy4vZGlyZWN0aXZlcy9jbGFzdGVyJztcbmltcG9ydCB7IFlhT2JqZWN0TWFuYWdlciB9IGZyb20gJy4vZGlyZWN0aXZlcy9vYmplY3RNYW5hZ2VyJztcbmltcG9ydCB7IERvY3VtZW50UmVmLCBXaW5kb3dSZWYgfSBmcm9tICcuL3V0aWxzL2Jyb3dzZXItZ2xvYmFscyc7XG5cbmRlY2xhcmUgdmFyIHltYXBzOiBhbnk7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBZYU1hcHNBUElXcmFwcGVyIHtcbiAgICBwcml2YXRlIF9tYXA6IFByb21pc2U8bWFwVHlwZXMuWWFuZGV4TWFwPjtcbiAgICBwcml2YXRlIF9tYXBSZXNvbHZlcjogKHZhbHVlPzogbWFwVHlwZXMuWWFuZGV4TWFwKSA9PiB2b2lkO1xuICAgIHByaXZhdGUgX2RvY3VtZW50UmVmOiBEb2N1bWVudFJlZjtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX2xvYWRlcjogWWFNYXBzQVBJTG9hZGVyLCBwcml2YXRlIF96b25lOiBOZ1pvbmUsIGQ6IERvY3VtZW50UmVmKSB7XG4gICAgICAgIHRoaXMuX2RvY3VtZW50UmVmID0gZDtcbiAgICAgICAgdGhpcy5fbWFwID0gbmV3IFByb21pc2U8bWFwVHlwZXMuWWFuZGV4TWFwPigocmVzb2x2ZTogKCkgPT4gdm9pZCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fbWFwUmVzb2x2ZXIgPSByZXNvbHZlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY3JlYXRlTWFwKGVsOiBIVE1MRWxlbWVudCwgbWFwT3B0aW9uczogbWFwVHlwZXMuTWFwT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCByZXMgPSB0aGlzLl9sb2FkZXIubG9hZCgpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY3JlYXRlID0gKCkgPT4gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHltYXBzLk1hcCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXAgPSBuZXcgeW1hcHMuTWFwKGVsLCBtYXBPcHRpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWFwUmVzb2x2ZXIobWFwIGFzIG1hcFR5cGVzLllhbmRleE1hcCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY3JlYXRlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgMTAwKTtcbiAgICAgICAgICAgIGNyZWF0ZSgpO1xuICAgICAgICB9KS5jYXRjaCgoZSkgPT4gY29uc29sZS5sb2coZSkpO1xuICAgICAgICByZXR1cm4gcmVzO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXRDZW50ZXIobGF0aXR1ZGU6IG51bWJlciwgbG9uZ2l0dWRlOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5fbWFwLnRoZW4oKG1hcDogbWFwVHlwZXMuWWFuZGV4TWFwKSA9PiB7XG4gICAgICAgICAgICBtYXAuc2V0Q2VudGVyKFtsYXRpdHVkZSwgbG9uZ2l0dWRlXSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRDZW50ZXIoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9tYXAudGhlbigobWFwOiBtYXBUeXBlcy5ZYW5kZXhNYXApID0+IHtcbiAgICAgICAgICAgIHJldHVybiBtYXAuZ2V0Q2VudGVyKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBwYW5Ubyhwb2ludHM6IGFueVtdLCBvcHRpb25zOiBhbnlbXSkge1xuICAgICAgICB0aGlzLl9tYXAudGhlbigobWFwOiBtYXBUeXBlcy5ZYW5kZXhNYXApID0+IHtcbiAgICAgICAgICAgIG1hcC5wYW5Ubyhwb2ludHMsIG9wdGlvbnMpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3Vic2NyaWJlVG9NYXBFdmVudDxFPihldmVudE5hbWU6IHN0cmluZyk6IE9ic2VydmFibGU8RT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyOiBPYnNlcnZlcjxFPikgPT4ge1xuICAgICAgICAgICAgdGhpcy5fbWFwLnRoZW4oKG06IG1hcFR5cGVzLllhbmRleE1hcCkgPT4ge1xuICAgICAgICAgICAgICAgIG0uZXZlbnRzLmFkZChldmVudE5hbWUsIChhcmc6IEUpID0+IHsgdGhpcy5fem9uZS5ydW4oKCkgPT4gb2JzZXJ2ZXIubmV4dChhcmcpKTsgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZU1hcmtlcihtYXJrZXI6IFlhTWFya2VyKTogUHJvbWlzZTxtYXBUeXBlcy5NYXJrZXI+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX21hcC50aGVuKChtYXA6IG1hcFR5cGVzLllhbmRleE1hcCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbSA9IG5ldyB5bWFwcy5QbGFjZW1hcmsoW21hcmtlci5sYXRpdHVkZSwgbWFya2VyLmxvbmdpdHVkZV0sIHtcbiAgICAgICAgICAgICAgICBiYWxsb29uQ29udGVudEhlYWRlcjogbWFya2VyLmJhbGxvb25Db250ZW50SGVhZGVyLFxuICAgICAgICAgICAgICAgIGJhbGxvb25Db250ZW50Qm9keTogbWFya2VyLmJhbGxvb25Db250ZW50Qm9keSxcbiAgICAgICAgICAgICAgICBiYWxsb29uQ29udGVudEZvb3RlcjogbWFya2VyLmJhbGxvb25Db250ZW50Rm9vdGVyLFxuICAgICAgICAgICAgICAgIGljb25Db250ZW50OiBtYXJrZXIuaWNvbkNvbnRlbnRcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBkcmFnZ2FibGU6IG1hcmtlci5kcmFnZ2FibGUsXG4gICAgICAgICAgICAgICAgICAgIHByZXNldDogbWFya2VyLnByZXNldCxcbiAgICAgICAgICAgICAgICAgICAgaWNvbkxheW91dDogbWFya2VyLmljb25MYXlvdXQsXG4gICAgICAgICAgICAgICAgICAgIGljb25JbWFnZUhyZWY6IG1hcmtlci5pY29uSW1hZ2VIcmVmLFxuICAgICAgICAgICAgICAgICAgICBpY29uSW1hZ2VTaXplOiBtYXJrZXIuaWNvbkltYWdlU2l6ZSxcbiAgICAgICAgICAgICAgICAgICAgaWNvbkltYWdlT2Zmc2V0OiBtYXJrZXIuaWNvbkltYWdlT2Zmc2V0XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBtYXAuZ2VvT2JqZWN0cy5hZGQobSk7XG4gICAgICAgICAgICByZXR1cm4gbTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlbW92ZUdlbyhvdmVybGF5OiBhbnkpIHtcbiAgICAgICAgdGhpcy5fbWFwLnRoZW4oKG1hcDogbWFwVHlwZXMuWWFuZGV4TWFwKSA9PiB7XG4gICAgICAgICAgICBtYXAuZ2VvT2JqZWN0cy5yZW1vdmUob3ZlcmxheSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBjcmVhdGVDbGFzdGVyKGNsYXN0ZXI6IFlhQ2xhc3Rlcik6IFByb21pc2U8bWFwVHlwZXMuQ2xhc3Rlcj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fbWFwLnRoZW4oKG1hcDogbWFwVHlwZXMuWWFuZGV4TWFwKSA9PiB7XG4gICAgICAgICAgICBpZiAoY2xhc3Rlci5tYXJrZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IG15R2VvT2JqZWN0czogYW55W107XG4gICAgICAgICAgICBteUdlb09iamVjdHMgPSBuZXcgQXJyYXk8YW55PigpO1xuICAgICAgICAgICAgY2xhc3Rlci5tYXJrZXJzLmZvckVhY2goKHg6IG1hcFR5cGVzLk1hcmtlckNsYXN0ZXIpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBwb2ludCA9IG5ldyB5bWFwcy5HZW9PYmplY3Qoe1xuICAgICAgICAgICAgICAgICAgICBnZW9tZXRyeTogeyB0eXBlOiB4LnR5cGUsIGNvb3JkaW5hdGVzOiBbeC5sYXQsIHgubG5nXSB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgbXlHZW9PYmplY3RzLnB1c2gocG9pbnQpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGNsdXN0ZXJlciA9IG5ldyB5bWFwcy5DbHVzdGVyZXIoe30pO1xuICAgICAgICAgICAgY2x1c3RlcmVyLmFkZChteUdlb09iamVjdHMpO1xuICAgICAgICAgICAgbWFwLmdlb09iamVjdHMuYWRkKGNsdXN0ZXJlcik7XG5cbiAgICAgICAgICAgIHJldHVybiBjbHVzdGVyZXI7XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZU9iamVjdE1hbmFnZXIob2JqZWN0TWFuYWdlcjogWWFPYmplY3RNYW5hZ2VyKTogYW55IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX21hcC50aGVuKChtYXA6IG1hcFR5cGVzLllhbmRleE1hcCkgPT4ge1xuXG4gICAgICAgICAgICBpZiAob2JqZWN0TWFuYWdlci5kYXRhc291cmNlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgbmF0aXZlT2JqZWN0TWFuYWdlciA9IG5ldyB5bWFwcy5PYmplY3RNYW5hZ2VyKHtcbiAgICAgICAgICAgICAgICBjbHVzdGVyaXplOiBvYmplY3RNYW5hZ2VyLmNsdXN0ZXJpemUsXG4gICAgICAgICAgICAgICAgZ3JpZFNpemU6IG9iamVjdE1hbmFnZXIuZ3JpZFNpemVcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBuYXRpdmVPYmplY3RNYW5hZ2VyLmFkZChvYmplY3RNYW5hZ2VyLmRhdGFzb3VyY2UpO1xuXG4gICAgICAgICAgICBuYXRpdmVPYmplY3RNYW5hZ2VyLm9iamVjdHMub3B0aW9ucy5zZXQoJ3ByZXNldCcsIG9iamVjdE1hbmFnZXIub2JqZWN0UHJlc2V0KTtcbiAgICAgICAgICAgIG5hdGl2ZU9iamVjdE1hbmFnZXIuY2x1c3RlcnMub3B0aW9ucy5zZXQoJ3ByZXNldCcsIG9iamVjdE1hbmFnZXIuY2xhc3RlclByZXNldCk7XG4gICAgICAgICAgICBtYXAuZ2VvT2JqZWN0cy5hZGQobmF0aXZlT2JqZWN0TWFuYWdlcik7XG4gICAgICAgICAgICByZXR1cm4gbmF0aXZlT2JqZWN0TWFuYWdlcjtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIG5hdmlnYXRlVG9HZW9PYmplY3Qob2JqZWN0TWFuYWdlcjogYW55LCBpZDogYW55KSB7XG4gICAgICAgIGNvbnN0IG9iaiA9IG9iamVjdE1hbmFnZXIub2JqZWN0cy5nZXRCeUlkKGlkKTtcbiAgICAgICAgaWYgKG9iaikge1xuICAgICAgICAgICAgdGhpcy5zZXRDZW50ZXIob2JqLmdlb21ldHJ5LmNvb3JkaW5hdGVzWzBdLCBvYmouZ2VvbWV0cnkuY29vcmRpbmF0ZXNbMV0pO1xuICAgICAgICAgICAgb2JqZWN0TWFuYWdlci5vYmplY3RzLmJhbGxvb24ub3BlbihpZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgY2hlY2tZYVNjaXB0TG9hZGVkKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZG9jdW1lbnRSZWYuZ2V0TmF0aXZlRG9jdW1lbnQoKS5nZXRFbGVtZW50QnlJZCgnWWFTY3JpcHQnKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb2JqZWN0TWFuYWdlclNldEZpbHRlcihvYmplY3RNYW5hZ2VyOiBhbnksIGZpbHRlcjogYW55KSB7XG4gICAgICAgIG9iamVjdE1hbmFnZXIuc2V0RmlsdGVyKGZpbHRlcik7XG4gICAgfVxuXG59XG4iXX0=