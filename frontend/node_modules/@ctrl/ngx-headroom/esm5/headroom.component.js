import * as tslib_1 from "tslib";
import { animate, state, style, transition, trigger, } from '@angular/animations';
import { DOCUMENT } from '@angular/common';
import { ChangeDetectionStrategy, Component, EventEmitter, HostListener, Inject, Input, Output, ViewChild, } from '@angular/core';
import shouldUpdate from './shouldUpdate';
var HeadroomComponent = /** @class */ (function () {
    function HeadroomComponent(document) {
        this.document = document;
        this.wrapperClassName = '';
        this.innerClassName = '';
        this.innerStyle = {
            top: '0',
            left: '0',
            right: '0',
            zIndex: '1',
            position: 'relative',
        };
        /**
         * pass styles for the wrapper div
         * (this maintains the components vertical space at the top of the page)
         */
        this.wrapperStyle = {};
        /** disable pinning and unpinning */
        this.disable = false;
        /** scroll tolerance in px when scrolling up before component is pinned */
        this.upTolerance = 5;
        /** scroll tolerance in px when scrolling down before component is pinned */
        this.downTolerance = 0;
        /**
         * height in px where the header should start and stop pinning.
         * Useful when you have another element above Headroom
         */
        this.pinStart = 0;
        this.calcHeightOnResize = true;
        /** Duration of animation in ms */
        this.duration = 200;
        /** Easing of animation */
        this.easing = 'ease-in-out';
        this.pin = new EventEmitter();
        this.unpin = new EventEmitter();
        this.unfix = new EventEmitter();
        this.wrapperHeight = 0;
        this.currentScrollY = 0;
        this.lastKnownScrollY = 0;
        this.scrolled = false;
        this.resizeTicking = false;
        this.state = 'unfixed';
        this.translateY = '0px';
        this.scrollTicking = false;
    }
    HeadroomComponent.prototype.scroll = function () {
        this.handleScroll();
    };
    HeadroomComponent.prototype.resize = function () {
        this.handleResize();
    };
    HeadroomComponent.prototype.ngOnInit = function () {
        this.innerStyle.transform = "translateY(" + this.translateY + ")";
        if (this.disable === true) {
            this.handleUnfix();
        }
    };
    HeadroomComponent.prototype.getParent = function () {
        if (this.parent) {
            return this.parent();
        }
        if (this.document.documentElement && this.document.documentElement.scrollTop) {
            return this.document.documentElement;
        }
        if (this.document.body && this.document.body.scrollTop) {
            return this.document.body;
        }
        if (this.document.body && this.document.body.parentNode.scrollTop) {
            return this.document.body.parentNode;
        }
        return this.document;
    };
    HeadroomComponent.prototype.ngAfterContentInit = function () {
        this.setHeightOffset();
        this.wrapperHeight = this.height ? this.height : null;
    };
    HeadroomComponent.prototype.setHeightOffset = function () {
        var _this = this;
        this.height = null;
        setTimeout(function () {
            _this.height = _this.inner.nativeElement.offsetHeight;
            _this.resizeTicking = false;
        }, 0);
    };
    HeadroomComponent.prototype.getScrollY = function () {
        if (this.getParent().pageYOffset !== undefined) {
            return this.getParent().pageYOffset;
        }
        return this.getParent().scrollTop || 0;
    };
    HeadroomComponent.prototype.getViewportHeight = function () {
        return (this.getParent().innerHeight ||
            this.document.documentElement.clientHeight ||
            this.document.body.clientHeight);
    };
    HeadroomComponent.prototype.getDocumentHeight = function () {
        var body = this.document.body;
        var documentElement = this.document.documentElement;
        return Math.max(body.scrollHeight, documentElement.scrollHeight, body.offsetHeight, documentElement.offsetHeight, body.clientHeight, documentElement.clientHeight);
    };
    HeadroomComponent.prototype.getElementPhysicalHeight = function (elm) {
        return Math.max(elm.offsetHeight, elm.clientHeight);
    };
    HeadroomComponent.prototype.getElementHeight = function (elm) {
        return Math.max(elm.scrollHeight, elm.offsetHeight, elm.clientHeight);
    };
    HeadroomComponent.prototype.getScrollerPhysicalHeight = function () {
        var parent = this.getParent();
        return parent === this.getParent() || parent === this.document.body
            ? this.getViewportHeight()
            : this.getElementPhysicalHeight(parent);
    };
    HeadroomComponent.prototype.getScrollerHeight = function () {
        var parent = this.getParent();
        return parent === this.getParent() || parent === this.document.body
            ? this.getDocumentHeight()
            : this.getElementHeight(parent);
    };
    HeadroomComponent.prototype.isOutOfBound = function (currentScrollY) {
        var pastTop = currentScrollY < 0;
        var scrollerPhysicalHeight = this.getScrollerPhysicalHeight();
        var scrollerHeight = this.getScrollerHeight();
        var pastBottom = currentScrollY + scrollerPhysicalHeight > scrollerHeight;
        return pastTop || pastBottom;
    };
    HeadroomComponent.prototype.handleScroll = function () {
        if (this.disable) {
            return;
        }
        if (!this.scrollTicking) {
            this.scrollTicking = true;
            this.update();
        }
    };
    HeadroomComponent.prototype.handleResize = function () {
        if (this.disable || !this.calcHeightOnResize) {
            return;
        }
        if (!this.resizeTicking) {
            this.resizeTicking = true;
            this.setHeightOffset();
        }
    };
    HeadroomComponent.prototype.handleUnpin = function () {
        this.unpin.emit();
        this.state = 'unpinned';
        this.innerStyle.position =
            this.disable || this.state === 'unfixed' ? 'relative' : 'fixed';
    };
    HeadroomComponent.prototype.handlePin = function () {
        this.pin.emit();
        this.state = 'pinned';
        this.innerStyle.position =
            this.disable || this.state === 'unfixed' ? 'relative' : 'fixed';
    };
    HeadroomComponent.prototype.handleUnfix = function () {
        this.unfix.emit();
        this.state = 'unfixed';
        this.innerStyle.position =
            this.disable || this.state === 'unfixed' ? 'relative' : 'fixed';
    };
    HeadroomComponent.prototype.update = function () {
        this.currentScrollY = this.getScrollY();
        if (!this.isOutOfBound(this.currentScrollY)) {
            var action = shouldUpdate(this.lastKnownScrollY, this.currentScrollY, this.disable, this.pinStart, this.downTolerance, this.upTolerance, this.state, this.height).action;
            if (action === 'pin') {
                this.handlePin();
            }
            else if (action === 'unpin') {
                this.handleUnpin();
            }
            else if (action === 'unfix') {
                this.handleUnfix();
            }
        }
        this.lastKnownScrollY = this.currentScrollY;
        this.scrollTicking = false;
    };
    HeadroomComponent.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
    ]; };
    tslib_1.__decorate([
        Input()
    ], HeadroomComponent.prototype, "wrapperClassName", void 0);
    tslib_1.__decorate([
        Input()
    ], HeadroomComponent.prototype, "innerClassName", void 0);
    tslib_1.__decorate([
        Input()
    ], HeadroomComponent.prototype, "innerStyle", void 0);
    tslib_1.__decorate([
        Input()
    ], HeadroomComponent.prototype, "wrapperStyle", void 0);
    tslib_1.__decorate([
        Input()
    ], HeadroomComponent.prototype, "disable", void 0);
    tslib_1.__decorate([
        Input()
    ], HeadroomComponent.prototype, "upTolerance", void 0);
    tslib_1.__decorate([
        Input()
    ], HeadroomComponent.prototype, "downTolerance", void 0);
    tslib_1.__decorate([
        Input()
    ], HeadroomComponent.prototype, "pinStart", void 0);
    tslib_1.__decorate([
        Input()
    ], HeadroomComponent.prototype, "calcHeightOnResize", void 0);
    tslib_1.__decorate([
        Input()
    ], HeadroomComponent.prototype, "duration", void 0);
    tslib_1.__decorate([
        Input()
    ], HeadroomComponent.prototype, "easing", void 0);
    tslib_1.__decorate([
        Output()
    ], HeadroomComponent.prototype, "pin", void 0);
    tslib_1.__decorate([
        Output()
    ], HeadroomComponent.prototype, "unpin", void 0);
    tslib_1.__decorate([
        Output()
    ], HeadroomComponent.prototype, "unfix", void 0);
    tslib_1.__decorate([
        ViewChild('ref', { static: true })
    ], HeadroomComponent.prototype, "inner", void 0);
    tslib_1.__decorate([
        Input()
    ], HeadroomComponent.prototype, "parent", void 0);
    tslib_1.__decorate([
        Input(), HostListener('window:scroll')
    ], HeadroomComponent.prototype, "scroll", null);
    tslib_1.__decorate([
        Input(),
        HostListener('window:resize')
    ], HeadroomComponent.prototype, "resize", null);
    HeadroomComponent = tslib_1.__decorate([
        Component({
            selector: 'ngx-headroom',
            template: "\n  <div [ngStyle]=\"wrapperStyle\" class=\"headroom-wrapper {{ wrapperClassName }}\"\n    [style.height.px]=\"wrapperHeight\">\n    <div #ref\n      [@headroom]=\"{\n        value: state,\n        params: {\n          duration: duration,\n          easing: easing\n        }\n      }\"\n      [ngStyle]=\"innerStyle\"\n      [class]=\"innerClassName\"\n      [class.headroom]=\"true\"\n      [class.headroom--unfixed]=\"state === 'unfixed'\"\n      [class.headroom--unpinned]=\"state === 'unpinned'\"\n      [class.headroom--pinned]=\"state === 'pinned'\"\n      [class.headroom--unfixed]=\"state === 'unfixed'\">\n      <ng-content></ng-content>\n    </div>\n  </div>\n  ",
            animations: [
                trigger('headroom', [
                    state('unfixed', style({
                        transform: 'translateY(0)',
                    })),
                    state('unpinned', style({
                        transform: 'translateY(-100%)',
                    })),
                    state('pinned', style({
                        transform: 'translateY(0px)',
                    })),
                    transition('unpinned <=> pinned', animate('{{ duration }}ms {{ easing }}')),
                ]),
            ],
            preserveWhitespaces: false,
            changeDetection: ChangeDetectionStrategy.OnPush
        }),
        tslib_1.__param(0, Inject(DOCUMENT))
    ], HeadroomComponent);
    return HeadroomComponent;
}());
export { HeadroomComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVhZHJvb20uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGN0cmwvbmd4LWhlYWRyb29tLyIsInNvdXJjZXMiOlsiaGVhZHJvb20uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsT0FBTyxFQUNQLEtBQUssRUFDTCxLQUFLLEVBQ0wsVUFBVSxFQUNWLE9BQU8sR0FDUixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBRUwsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFFVCxZQUFZLEVBQ1osWUFBWSxFQUNaLE1BQU0sRUFDTixLQUFLLEVBRUwsTUFBTSxFQUNOLFNBQVMsR0FDVixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLFlBQVksTUFBTSxnQkFBZ0IsQ0FBQztBQXVEMUM7SUEyREUsMkJBQXNDLFFBQWE7UUFBYixhQUFRLEdBQVIsUUFBUSxDQUFLO1FBMUQxQyxxQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFDdEIsbUJBQWMsR0FBRyxFQUFFLENBQUM7UUFDcEIsZUFBVSxHQUFRO1lBQ3pCLEdBQUcsRUFBRSxHQUFHO1lBQ1IsSUFBSSxFQUFFLEdBQUc7WUFDVCxLQUFLLEVBQUUsR0FBRztZQUNWLE1BQU0sRUFBRSxHQUFHO1lBQ1gsUUFBUSxFQUFFLFVBQVU7U0FDckIsQ0FBQztRQUNGOzs7V0FHRztRQUNNLGlCQUFZLEdBQVEsRUFBRSxDQUFDO1FBQ2hDLG9DQUFvQztRQUMzQixZQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ3pCLDBFQUEwRTtRQUNqRSxnQkFBVyxHQUFHLENBQUMsQ0FBQztRQUN6Qiw0RUFBNEU7UUFDbkUsa0JBQWEsR0FBRyxDQUFDLENBQUM7UUFDM0I7OztXQUdHO1FBQ00sYUFBUSxHQUFHLENBQUMsQ0FBQztRQUNiLHVCQUFrQixHQUFHLElBQUksQ0FBQztRQUNuQyxrQ0FBa0M7UUFDekIsYUFBUSxHQUFH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LFFBQVEsRUFBRSxjQUFjO1lBQ3hCLFFBQVEsRUFBRSxtcUJBcUJUO1lBQ0QsVUFBVSxFQUFFO2dCQUNWLE9BQU8sQ0FBQyxVQUFVLEVBQUU7b0JBQ2xCLEtBQUssQ0FDSCxTQUFTLEVBQ1QsS0FBSyxDQUFDO3dCQUNKLFNBQVMsRUFBRSxlQUFlO3FCQUMzQixDQUFDLENBQ0g7b0JBQ0QsS0FBSyxDQUNILFVBQVUsRUFDVixLQUFLLENBQUM7d0JBQ0osU0FBUyxFQUFFLG1CQUFtQjtxQkFDL0IsQ0FBQyxDQUNIO29CQUNELEtBQUssQ0FDSCxRQUFRLEVBQ1IsS0FBSyxDQUFDO3dCQUNKLFNBQVMsRUFBRSxpQkFBaUI7cUJBQzdCLENBQUMsQ0FDSDtvQkFDRCxVQUFVLENBQ1IscUJBQXFCLEVBQ3JCLE9BQU8sQ0FBQywrQkFBK0IsQ0FBQyxDQUN6QztpQkFDRixDQUFDO2FBQ0g7WUFDRCxtQkFBbUIsRUFBRSxLQUFLO1lBQzFCLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO1NBQ2hELENBQUM7UUE0RGEsbUJBQUEsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO09BM0RsQixpQkFBaUIsQ0FxTjdCO0lBQUQsd0JBQUM7Q0FBQSxBQXJORCxJQXFOQztTQXJOWSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBhbmltYXRlLFxuICBzdGF0ZSxcbiAgc3R5bGUsXG4gIHRyYW5zaXRpb24sXG4gIHRyaWdnZXIsXG59IGZyb20gJ0Bhbmd1bGFyL2FuaW1hdGlvbnMnO1xuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtcbiAgQWZ0ZXJDb250ZW50SW5pdCxcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIENvbXBvbmVudCxcbiAgRWxlbWVudFJlZixcbiAgRXZlbnRFbWl0dGVyLFxuICBIb3N0TGlzdGVuZXIsXG4gIEluamVjdCxcbiAgSW5wdXQsXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBWaWV3Q2hpbGQsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgc2hvdWxkVXBkYXRlIGZyb20gJy4vc2hvdWxkVXBkYXRlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmd4LWhlYWRyb29tJyxcbiAgdGVtcGxhdGU6IGBcbiAgPGRpdiBbbmdTdHlsZV09XCJ3cmFwcGVyU3R5bGVcIiBjbGFzcz1cImhlYWRyb29tLXdyYXBwZXIge3sgd3JhcHBlckNsYXNzTmFtZSB9fVwiXG4gICAgW3N0eWxlLmhlaWdodC5weF09XCJ3cmFwcGVySGVpZ2h0XCI+XG4gICAgPGRpdiAjcmVmXG4gICAgICBbQGhlYWRyb29tXT1cIntcbiAgICAgICAgdmFsdWU6IHN0YXRlLFxuICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICBkdXJhdGlvbjogZHVyYXRpb24sXG4gICAgICAgICAgZWFzaW5nOiBlYXNpbmdcbiAgICAgICAgfVxuICAgICAgfVwiXG4gICAgICBbbmdTdHlsZV09XCJpbm5lclN0eWxlXCJcbiAgICAgIFtjbGFzc109XCJpbm5lckNsYXNzTmFtZVwiXG4gICAgICBbY2xhc3MuaGVhZHJvb21dPVwidHJ1ZVwiXG4gICAgICBbY2xhc3MuaGVhZHJvb20tLXVuZml4ZWRdPVwic3RhdGUgPT09ICd1bmZpeGVkJ1wiXG4gICAgICBbY2xhc3MuaGVhZHJvb20tLXVucGlubmVkXT1cInN0YXRlID09PSAndW5waW5uZWQnXCJcbiAgICAgIFtjbGFzcy5oZWFkcm9vbS0tcGlubmVkXT1cInN0YXRlID09PSAncGlubmVkJ1wiXG4gICAgICBbY2xhc3MuaGVhZHJvb20tLXVuZml4ZWRdPVwic3RhdGUgPT09ICd1bmZpeGVkJ1wiPlxuICAgICAgPG5nLWNvbnRlbnQ+PC9uZy1jb250ZW50PlxuICAgIDwvZGl2PlxuICA8L2Rpdj5cbiAgYCxcbiAgYW5pbWF0aW9uczogW1xuICAgIHRyaWdnZXIoJ2hlYWRyb29tJywgW1xuICAgICAgc3RhdGUoXG4gICAgICAgICd1bmZpeGVkJyxcbiAgICAgICAgc3R5bGUoe1xuICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZVkoMCknLFxuICAgICAgICB9KSxcbiAgICAgICksXG4gICAgICBzdGF0ZShcbiAgICAgICAgJ3VucGlubmVkJyxcbiAgICAgICAgc3R5bGUoe1xuICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZVkoLTEwMCUpJyxcbiAgICAgICAgfSksXG4gICAgICApLFxuICAgICAgc3RhdGUoXG4gICAgICAgICdwaW5uZWQnLFxuICAgICAgICBzdHlsZSh7XG4gICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlWSgwcHgpJyxcbiAgICAgICAgfSksXG4gICAgICApLFxuICAgICAgdHJhbnNpdGlvbihcbiAgICAgICAgJ3VucGlubmVkIDw9PiBwaW5uZWQnLFxuICAgICAgICBhbmltYXRlKCd7eyBkdXJhdGlvbiB9fW1zIHt7IGVhc2luZyB9fScpLFxuICAgICAgKSxcbiAgICBdKSxcbiAgXSxcbiAgcHJlc2VydmVXaGl0ZXNwYWNlczogZmFsc2UsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBIZWFkcm9vbUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJDb250ZW50SW5pdCB7XG4gIEBJbnB1dCgpIHdyYXBwZXJDbGFzc05hbWUgPSAnJztcbiAgQElucHV0KCkgaW5uZXJDbGFzc05hbWUgPSAnJztcbiAgQElucHV0KCkgaW5uZXJTdHlsZTogYW55ID0ge1xuICAgIHRvcDogJzAnLFxuICAgIGxlZnQ6ICcwJyxcbiAgICByaWdodDogJzAnLFxuICAgIHpJbmRleDogJzEnLFxuICAgIHBvc2l0aW9uOiAncmVsYXRpdmUnLFxuICB9O1xuICAvKipcbiAgICogcGFzcyBzdHlsZXMgZm9yIHRoZSB3cmFwcGVyIGRpdlxuICAgKiAodGhpcyBtYWludGFpbnMgdGhlIGNvbXBvbmVudHMgdmVydGljYWwgc3BhY2UgYXQgdGhlIHRvcCBvZiB0aGUgcGFnZSlcbiAgICovXG4gIEBJbnB1dCgpIHdyYXBwZXJTdHlsZTogYW55ID0ge307XG4gIC8qKiBkaXNhYmxlIHBpbm5pbmcgYW5kIHVucGlubmluZyAqL1xuICBASW5wdXQoKSBkaXNhYmxlID0gZmFsc2U7XG4gIC8qKiBzY3JvbGwgdG9sZXJhbmNlIGluIHB4IHdoZW4gc2Nyb2xsaW5nIHVwIGJlZm9yZSBjb21wb25lbnQgaXMgcGlubmVkICovXG4gIEBJbnB1dCgpIHVwVG9sZXJhbmNlID0gNTtcbiAgLyoqIHNjcm9sbCB0b2xlcmFuY2UgaW4gcHggd2hlbiBzY3JvbGxpbmcgZG93biBiZWZvcmUgY29tcG9uZW50IGlzIHBpbm5lZCAqL1xuICBASW5wdXQoKSBkb3duVG9sZXJhbmNlID0gMDtcbiAgLyoqXG4gICAqIGhlaWdodCBpbiBweCB3aGVyZSB0aGUgaGVhZGVyIHNob3VsZCBzdGFydCBhbmQgc3RvcCBwaW5uaW5nLlxuICAgKiBVc2VmdWwgd2hlbiB5b3UgaGF2ZSBhbm90aGVyIGVsZW1lbnQgYWJvdmUgSGVhZHJvb21cbiAgICovXG4gIEBJbnB1dCgpIHBpblN0YXJ0ID0gMDtcbiAgQElucHV0KCkgY2FsY0hlaWdodE9uUmVzaXplID0gdHJ1ZTtcbiAgLyoqIER1cmF0aW9uIG9mIGFuaW1hdGlvbiBpbiBtcyAqL1xuICBASW5wdXQoKSBkdXJhdGlvbiA9IDIwMDtcbiAgLyoqIEVhc2luZyBvZiBhbmltYXRpb24gKi9cbiAgQElucHV0KCkgZWFzaW5nID0gJ2Vhc2UtaW4tb3V0JztcbiAgQE91dHB1dCgpIHBpbiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIHVucGluID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgdW5maXggPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBWaWV3Q2hpbGQoJ3JlZicsIHsgc3RhdGljOiB0cnVlIH0pIGlubmVyOiBFbGVtZW50UmVmO1xuICB3cmFwcGVySGVpZ2h0ID0gMDtcbiAgY3VycmVudFNjcm9sbFkgPSAwO1xuICBsYXN0S25vd25TY3JvbGxZID0gMDtcbiAgc2Nyb2xsZWQgPSBmYWxzZTtcbiAgcmVzaXplVGlja2luZyA9IGZhbHNlO1xuICBzdGF0ZSA9ICd1bmZpeGVkJztcbiAgdHJhbnNsYXRlWSA9ICcwcHgnO1xuICBoZWlnaHQ6IG51bWJlcjtcbiAgc2Nyb2xsVGlja2luZyA9IGZhbHNlO1xuICAvKipcbiAgICogcHJvdmlkZSBhIGN1c3RvbSAncGFyZW50JyBlbGVtZW50IGZvciBzY3JvbGwgZXZlbnRzLlxuICAgKiBgcGFyZW50YCBzaG91bGQgYmUgYSBmdW5jdGlvbiB3aGljaCByZXNvbHZlcyB0byB0aGUgZGVzaXJlZCBlbGVtZW50LlxuICAgKi9cbiAgQElucHV0KCkgcGFyZW50OiAoKSA9PiBhbnk7XG4gIEBJbnB1dCgpIEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzpzY3JvbGwnKVxuICBzY3JvbGwoKSB7XG4gICAgdGhpcy5oYW5kbGVTY3JvbGwoKTtcbiAgfVxuICBASW5wdXQoKVxuICBASG9zdExpc3RlbmVyKCd3aW5kb3c6cmVzaXplJylcbiAgcmVzaXplKCkge1xuICAgIHRoaXMuaGFuZGxlUmVzaXplKCk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIGRvY3VtZW50OiBhbnkpIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5pbm5lclN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGVZKCR7dGhpcy50cmFuc2xhdGVZfSlgO1xuXG4gICAgaWYgKHRoaXMuZGlzYWJsZSA9PT0gdHJ1ZSkge1xuICAgICAgdGhpcy5oYW5kbGVVbmZpeCgpO1xuICAgIH1cbiAgfVxuICBnZXRQYXJlbnQoKSB7XG4gICAgaWYgKHRoaXMucGFyZW50KSB7XG4gICAgICByZXR1cm4gdGhpcy5wYXJlbnQoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCkge1xuICAgICAgcmV0dXJuIHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50O1xuICAgIH1cbiAgICBpZiAodGhpcy5kb2N1bWVudC5ib2R5ICYmIHRoaXMuZG9jdW1lbnQuYm9keS5zY3JvbGxUb3ApIHtcbiAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmJvZHk7XG4gICAgfVxuICAgIGlmICh0aGlzLmRvY3VtZW50LmJvZHkgJiYgdGhpcy5kb2N1bWVudC5ib2R5LnBhcmVudE5vZGUuc2Nyb2xsVG9wKSB7XG4gICAgICByZXR1cm4gdGhpcy5kb2N1bWVudC5ib2R5LnBhcmVudE5vZGU7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmRvY3VtZW50O1xuICB9XG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpIHtcbiAgICB0aGlzLnNldEhlaWdodE9mZnNldCgpO1xuICAgIHRoaXMud3JhcHBlckhlaWdodCA9IHRoaXMuaGVpZ2h0ID8gdGhpcy5oZWlnaHQgOiBudWxsO1xuICB9XG4gIHNldEhlaWdodE9mZnNldCgpIHtcbiAgICB0aGlzLmhlaWdodCA9IG51bGw7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmhlaWdodCA9IHRoaXMuaW5uZXIubmF0aXZlRWxlbWVudC5vZmZzZXRIZWlnaHQ7XG4gICAgICB0aGlzLnJlc2l6ZVRpY2tpbmcgPSBmYWxzZTtcbiAgICB9LCAwKTtcbiAgfVxuICBnZXRTY3JvbGxZKCkge1xuICAgIGlmICh0aGlzLmdldFBhcmVudCgpLnBhZ2VZT2Zmc2V0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldFBhcmVudCgpLnBhZ2VZT2Zmc2V0O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5nZXRQYXJlbnQoKS5zY3JvbGxUb3AgfHwgMDtcbiAgfVxuICBnZXRWaWV3cG9ydEhlaWdodCgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5nZXRQYXJlbnQoKS5pbm5lckhlaWdodCB8fFxuICAgICAgdGhpcy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0IHx8XG4gICAgICB0aGlzLmRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0XG4gICAgKTtcbiAgfVxuICBnZXREb2N1bWVudEhlaWdodCgpIHtcbiAgICBjb25zdCBib2R5ID0gdGhpcy5kb2N1bWVudC5ib2R5O1xuICAgIGNvbnN0IGRvY3VtZW50RWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50O1xuXG4gICAgcmV0dXJuIE1hdGgubWF4KFxuICAgICAgYm9keS5zY3JvbGxIZWlnaHQsXG4gICAgICBkb2N1bWVudEVsZW1lbnQuc2Nyb2xsSGVpZ2h0LFxuICAgICAgYm9keS5vZmZzZXRIZWlnaHQsXG4gICAgICBkb2N1bWVudEVsZW1lbnQub2Zmc2V0SGVpZ2h0LFxuICAgICAgYm9keS5jbGllbnRIZWlnaHQsXG4gICAgICBkb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0LFxuICAgICk7XG4gIH1cbiAgZ2V0RWxlbWVudFBoeXNpY2FsSGVpZ2h0KGVsbTogYW55KSB7XG4gICAgcmV0dXJuIE1hdGgubWF4KGVsbS5vZmZzZXRIZWlnaHQsIGVsbS5jbGllbnRIZWlnaHQpO1xuICB9XG4gIGdldEVsZW1lbnRIZWlnaHQoZWxtOiBhbnkpIHtcbiAgICByZXR1cm4gTWF0aC5tYXgoZWxtLnNjcm9sbEhlaWdodCwgZWxtLm9mZnNldEhlaWdodCwgZWxtLmNsaWVudEhlaWdodCk7XG4gIH1cbiAgZ2V0U2Nyb2xsZXJQaHlzaWNhbEhlaWdodCgpIHtcbiAgICBjb25zdCBwYXJlbnQgPSB0aGlzLmdldFBhcmVudCgpO1xuXG4gICAgcmV0dXJuIHBhcmVudCA9PT0gdGhpcy5nZXRQYXJlbnQoKSB8fCBwYXJlbnQgPT09IHRoaXMuZG9jdW1lbnQuYm9keVxuICAgICAgPyB0aGlzLmdldFZpZXdwb3J0SGVpZ2h0KClcbiAgICAgIDogdGhpcy5nZXRFbGVtZW50UGh5c2ljYWxIZWlnaHQocGFyZW50KTtcbiAgfVxuICBnZXRTY3JvbGxlckhlaWdodCgpIHtcbiAgICBjb25zdCBwYXJlbnQgPSB0aGlzLmdldFBhcmVudCgpO1xuXG4gICAgcmV0dXJuIHBhcmVudCA9PT0gdGhpcy5nZXRQYXJlbnQoKSB8fCBwYXJlbnQgPT09IHRoaXMuZG9jdW1lbnQuYm9keVxuICAgICAgPyB0aGlzLmdldERvY3VtZW50SGVpZ2h0KClcbiAgICAgIDogdGhpcy5nZXRFbGVtZW50SGVpZ2h0KHBhcmVudCk7XG4gIH1cbiAgaXNPdXRPZkJvdW5kKGN1cnJlbnRTY3JvbGxZKSB7XG4gICAgY29uc3QgcGFzdFRvcCA9IGN1cnJlbnRTY3JvbGxZIDwgMDtcblxuICAgIGNvbnN0IHNjcm9sbGVyUGh5c2ljYWxIZWlnaHQgPSB0aGlzLmdldFNjcm9sbGVyUGh5c2ljYWxIZWlnaHQoKTtcbiAgICBjb25zdCBzY3JvbGxlckhlaWdodCA9IHRoaXMuZ2V0U2Nyb2xsZXJIZWlnaHQoKTtcblxuICAgIGNvbnN0IHBhc3RCb3R0b20gPSBjdXJyZW50U2Nyb2xsWSArIHNjcm9sbGVyUGh5c2ljYWxIZWlnaHQgPiBzY3JvbGxlckhlaWdodDtcblxuICAgIHJldHVybiBwYXN0VG9wIHx8IHBhc3RCb3R0b207XG4gIH1cbiAgaGFuZGxlU2Nyb2xsKCkge1xuICAgIGlmICh0aGlzLmRpc2FibGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnNjcm9sbFRpY2tpbmcpIHtcbiAgICAgIHRoaXMuc2Nyb2xsVGlja2luZyA9IHRydWU7XG4gICAgICB0aGlzLnVwZGF0ZSgpO1xuICAgIH1cbiAgfVxuICBoYW5kbGVSZXNpemUoKSB7XG4gICAgaWYgKHRoaXMuZGlzYWJsZSB8fCAhdGhpcy5jYWxjSGVpZ2h0T25SZXNpemUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnJlc2l6ZVRpY2tpbmcpIHtcbiAgICAgIHRoaXMucmVzaXplVGlja2luZyA9IHRydWU7XG4gICAgICB0aGlzLnNldEhlaWdodE9mZnNldCgpO1xuICAgIH1cbiAgfVxuICBoYW5kbGVVbnBpbigpIHtcbiAgICB0aGlzLnVucGluLmVtaXQoKTtcbiAgICB0aGlzLnN0YXRlID0gJ3VucGlubmVkJztcbiAgICB0aGlzLmlubmVyU3R5bGUucG9zaXRpb24gPVxuICAgICAgdGhpcy5kaXNhYmxlIHx8IHRoaXMuc3RhdGUgPT09ICd1bmZpeGVkJyA/ICdyZWxhdGl2ZScgOiAnZml4ZWQnO1xuICB9XG4gIGhhbmRsZVBpbigpIHtcbiAgICB0aGlzLnBpbi5lbWl0KCk7XG4gICAgdGhpcy5zdGF0ZSA9ICdwaW5uZWQnO1xuICAgIHRoaXMuaW5uZXJTdHlsZS5wb3NpdGlvbiA9XG4gICAgICB0aGlzLmRpc2FibGUgfHwgdGhpcy5zdGF0ZSA9PT0gJ3VuZml4ZWQnID8gJ3JlbGF0aXZlJyA6ICdmaXhlZCc7XG4gIH1cbiAgaGFuZGxlVW5maXgoKSB7XG4gICAgdGhpcy51bmZpeC5lbWl0KCk7XG4gICAgdGhpcy5zdGF0ZSA9ICd1bmZpeGVkJztcbiAgICB0aGlzLmlubmVyU3R5bGUucG9zaXRpb24gPVxuICAgICAgdGhpcy5kaXNhYmxlIHx8IHRoaXMuc3RhdGUgPT09ICd1bmZpeGVkJyA/ICdyZWxhdGl2ZScgOiAnZml4ZWQnO1xuICB9XG4gIHVwZGF0ZSgpIHtcbiAgICB0aGlzLmN1cnJlbnRTY3JvbGxZID0gdGhpcy5nZXRTY3JvbGxZKCk7XG5cbiAgICBpZiAoIXRoaXMuaXNPdXRPZkJvdW5kKHRoaXMuY3VycmVudFNjcm9sbFkpKSB7XG4gICAgICBjb25zdCB7IGFjdGlvbiB9ID0gc2hvdWxkVXBkYXRlKFxuICAgICAgICB0aGlzLmxhc3RLbm93blNjcm9sbFksXG4gICAgICAgIHRoaXMuY3VycmVudFNjcm9sbFksXG4gICAgICAgIHRoaXMuZGlzYWJsZSxcbiAgICAgICAgdGhpcy5waW5TdGFydCxcbiAgICAgICAgdGhpcy5kb3duVG9sZXJhbmNlLFxuICAgICAgICB0aGlzLnVwVG9sZXJhbmNlLFxuICAgICAgICB0aGlzLnN0YXRlLFxuICAgICAgICB0aGlzLmhlaWdodCxcbiAgICAgICk7XG5cbiAgICAgIGlmIChhY3Rpb24gPT09ICdwaW4nKSB7XG4gICAgICAgIHRoaXMuaGFuZGxlUGluKCk7XG4gICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3VucGluJykge1xuICAgICAgICB0aGlzLmhhbmRsZVVucGluKCk7XG4gICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3VuZml4Jykge1xuICAgICAgICB0aGlzLmhhbmRsZVVuZml4KCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5sYXN0S25vd25TY3JvbGxZID0gdGhpcy5jdXJyZW50U2Nyb2xsWTtcbiAgICB0aGlzLnNjcm9sbFRpY2tpbmcgPSBmYWxzZTtcbiAgfVxufVxuIl19