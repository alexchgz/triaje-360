import * as tslib_1 from "tslib";
import { animate, state, style, transition, trigger, } from '@angular/animations';
import { DOCUMENT } from '@angular/common';
import { ChangeDetectionStrategy, Component, EventEmitter, HostListener, Inject, Input, Output, ViewChild, } from '@angular/core';
import shouldUpdate from './shouldUpdate';
let HeadroomComponent = class HeadroomComponent {
    constructor(document) {
        this.document = document;
        this.wrapperClassName = '';
        this.innerClassName = '';
        this.innerStyle = {
            top: '0',
            left: '0',
            right: '0',
            zIndex: '1',
            position: 'relative',
        };
        /**
         * pass styles for the wrapper div
         * (this maintains the components vertical space at the top of the page)
         */
        this.wrapperStyle = {};
        /** disable pinning and unpinning */
        this.disable = false;
        /** scroll tolerance in px when scrolling up before component is pinned */
        this.upTolerance = 5;
        /** scroll tolerance in px when scrolling down before component is pinned */
        this.downTolerance = 0;
        /**
         * height in px where the header should start and stop pinning.
         * Useful when you have another element above Headroom
         */
        this.pinStart = 0;
        this.calcHeightOnResize = true;
        /** Duration of animation in ms */
        this.duration = 200;
        /** Easing of animation */
        this.easing = 'ease-in-out';
        this.pin = new EventEmitter();
        this.unpin = new EventEmitter();
        this.unfix = new EventEmitter();
        this.wrapperHeight = 0;
        this.currentScrollY = 0;
        this.lastKnownScrollY = 0;
        this.scrolled = false;
        this.resizeTicking = false;
        this.state = 'unfixed';
        this.translateY = '0px';
        this.scrollTicking = false;
    }
    scroll() {
        this.handleScroll();
    }
    resize() {
        this.handleResize();
    }
    ngOnInit() {
        this.innerStyle.transform = `translateY(${this.translateY})`;
        if (this.disable === true) {
            this.handleUnfix();
        }
    }
    getParent() {
        if (this.parent) {
            return this.parent();
        }
        if (this.document.documentElement && this.document.documentElement.scrollTop) {
            return this.document.documentElement;
        }
        if (this.document.body && this.document.body.scrollTop) {
            return this.document.body;
        }
        if (this.document.body && this.document.body.parentNode.scrollTop) {
            return this.document.body.parentNode;
        }
        return this.document;
    }
    ngAfterContentInit() {
        this.setHeightOffset();
        this.wrapperHeight = this.height ? this.height : null;
    }
    setHeightOffset() {
        this.height = null;
        setTimeout(() => {
            this.height = this.inner.nativeElement.offsetHeight;
            this.resizeTicking = false;
        }, 0);
    }
    getScrollY() {
        if (this.getParent().pageYOffset !== undefined) {
            return this.getParent().pageYOffset;
        }
        return this.getParent().scrollTop || 0;
    }
    getViewportHeight() {
        return (this.getParent().innerHeight ||
            this.document.documentElement.clientHeight ||
            this.document.body.clientHeight);
    }
    getDocumentHeight() {
        const body = this.document.body;
        const documentElement = this.document.documentElement;
        return Math.max(body.scrollHeight, documentElement.scrollHeight, body.offsetHeight, documentElement.offsetHeight, body.clientHeight, documentElement.clientHeight);
    }
    getElementPhysicalHeight(elm) {
        return Math.max(elm.offsetHeight, elm.clientHeight);
    }
    getElementHeight(elm) {
        return Math.max(elm.scrollHeight, elm.offsetHeight, elm.clientHeight);
    }
    getScrollerPhysicalHeight() {
        const parent = this.getParent();
        return parent === this.getParent() || parent === this.document.body
            ? this.getViewportHeight()
            : this.getElementPhysicalHeight(parent);
    }
    getScrollerHeight() {
        const parent = this.getParent();
        return parent === this.getParent() || parent === this.document.body
            ? this.getDocumentHeight()
            : this.getElementHeight(parent);
    }
    isOutOfBound(currentScrollY) {
        const pastTop = currentScrollY < 0;
        const scrollerPhysicalHeight = this.getScrollerPhysicalHeight();
        const scrollerHeight = this.getScrollerHeight();
        const pastBottom = currentScrollY + scrollerPhysicalHeight > scrollerHeight;
        return pastTop || pastBottom;
    }
    handleScroll() {
        if (this.disable) {
            return;
        }
        if (!this.scrollTicking) {
            this.scrollTicking = true;
            this.update();
        }
    }
    handleResize() {
        if (this.disable || !this.calcHeightOnResize) {
            return;
        }
        if (!this.resizeTicking) {
            this.resizeTicking = true;
            this.setHeightOffset();
        }
    }
    handleUnpin() {
        this.unpin.emit();
        this.state = 'unpinned';
        this.innerStyle.position =
            this.disable || this.state === 'unfixed' ? 'relative' : 'fixed';
    }
    handlePin() {
        this.pin.emit();
        this.state = 'pinned';
        this.innerStyle.position =
            this.disable || this.state === 'unfixed' ? 'relative' : 'fixed';
    }
    handleUnfix() {
        this.unfix.emit();
        this.state = 'unfixed';
        this.innerStyle.position =
            this.disable || this.state === 'unfixed' ? 'relative' : 'fixed';
    }
    update() {
        this.currentScrollY = this.getScrollY();
        if (!this.isOutOfBound(this.currentScrollY)) {
            const { action } = shouldUpdate(this.lastKnownScrollY, this.currentScrollY, this.disable, this.pinStart, this.downTolerance, this.upTolerance, this.state, this.height);
            if (action === 'pin') {
                this.handlePin();
            }
            else if (action === 'unpin') {
                this.handleUnpin();
            }
            else if (action === 'unfix') {
                this.handleUnfix();
            }
        }
        this.lastKnownScrollY = this.currentScrollY;
        this.scrollTicking = false;
    }
};
HeadroomComponent.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
tslib_1.__decorate([
    Input()
], HeadroomComponent.prototype, "wrapperClassName", void 0);
tslib_1.__decorate([
    Input()
], HeadroomComponent.prototype, "innerClassName", void 0);
tslib_1.__decorate([
    Input()
], HeadroomComponent.prototype, "innerStyle", void 0);
tslib_1.__decorate([
    Input()
], HeadroomComponent.prototype, "wrapperStyle", void 0);
tslib_1.__decorate([
    Input()
], HeadroomComponent.prototype, "disable", void 0);
tslib_1.__decorate([
    Input()
], HeadroomComponent.prototype, "upTolerance", void 0);
tslib_1.__decorate([
    Input()
], HeadroomComponent.prototype, "downTolerance", void 0);
tslib_1.__decorate([
    Input()
], HeadroomComponent.prototype, "pinStart", void 0);
tslib_1.__decorate([
    Input()
], HeadroomComponent.prototype, "calcHeightOnResize", void 0);
tslib_1.__decorate([
    Input()
], HeadroomComponent.prototype, "duration", void 0);
tslib_1.__decorate([
    Input()
], HeadroomComponent.prototype, "easing", void 0);
tslib_1.__decorate([
    Output()
], HeadroomComponent.prototype, "pin", void 0);
tslib_1.__decorate([
    Output()
], HeadroomComponent.prototype, "unpin", void 0);
tslib_1.__decorate([
    Output()
], HeadroomComponent.prototype, "unfix", void 0);
tslib_1.__decorate([
    ViewChild('ref', { static: true })
], HeadroomComponent.prototype, "inner", void 0);
tslib_1.__decorate([
    Input()
], HeadroomComponent.prototype, "parent", void 0);
tslib_1.__decorate([
    Input(), HostListener('window:scroll')
], HeadroomComponent.prototype, "scroll", null);
tslib_1.__decorate([
    Input(),
    HostListener('window:resize')
], HeadroomComponent.prototype, "resize", null);
HeadroomComponent = tslib_1.__decorate([
    Component({
        selector: 'ngx-headroom',
        template: `
  <div [ngStyle]="wrapperStyle" class="headroom-wrapper {{ wrapperClassName }}"
    [style.height.px]="wrapperHeight">
    <div #ref
      [@headroom]="{
        value: state,
        params: {
          duration: duration,
          easing: easing
        }
      }"
      [ngStyle]="innerStyle"
      [class]="innerClassName"
      [class.headroom]="true"
      [class.headroom--unfixed]="state === 'unfixed'"
      [class.headroom--unpinned]="state === 'unpinned'"
      [class.headroom--pinned]="state === 'pinned'"
      [class.headroom--unfixed]="state === 'unfixed'">
      <ng-content></ng-content>
    </div>
  </div>
  `,
        animations: [
            trigger('headroom', [
                state('unfixed', style({
                    transform: 'translateY(0)',
                })),
                state('unpinned', style({
                    transform: 'translateY(-100%)',
                })),
                state('pinned', style({
                    transform: 'translateY(0px)',
                })),
                transition('unpinned <=> pinned', animate('{{ duration }}ms {{ easing }}')),
            ]),
        ],
        preserveWhitespaces: false,
        changeDetection: ChangeDetectionStrategy.OnPush
    }),
    tslib_1.__param(0, Inject(DOCUMENT))
], HeadroomComponent);
export { HeadroomComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVhZHJvb20uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGN0cmwvbmd4LWhlYWRyb29tLyIsInNvdXJjZXMiOlsiaGVhZHJvb20uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsT0FBTyxFQUNQLEtBQUssRUFDTCxLQUFLLEVBQ0wsVUFBVSxFQUNWLE9BQU8sR0FDUixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBRUwsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFFVCxZQUFZLEVBQ1osWUFBWSxFQUNaLE1BQU0sRUFDTixLQUFLLEVBRUwsTUFBTSxFQUNOLFNBQVMsR0FDVixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLFlBQVksTUFBTSxnQkFBZ0IsQ0FBQztBQXVEMUMsSUFBYSxpQkFBaUIsR0FBOUIsTUFBYSxpQkFBaUI7SUEyRDVCLFlBQXNDLFFBQWE7UUFBYixhQUFRLEdBQVIsUUFBUSxDQUFLO1FBMUQxQyxxQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFDdEIsbUJBQWMsR0FBRyxFQUFFLENBQUM7UUFDcEIsZUFBVSxHQUFRO1lBQ3pCLEdBQUcsRUFBRSxHQUFHO1lBQ1IsSUFBSSxFQUFFLEdBQUc7WUFDVCxLQUFLLEVBQUUsR0FBRztZQUNWLE1BQU0sRUFBRSxHQUFHO1lBQ1gsUUFBUSxFQUFFLFVBQVU7U0FDckIsQ0FBQztRQUNGOzs7V0FHRztRQUNNLGlCQUFZLEdBQVEsRUFBRSxDQUFDO1FBQ2hDLG9DQUFvQztRQUMzQixZQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ3pCLDBFQUEwRTtRQUNqRSxnQkFBVyxHQUFHLENBQUMsQ0FBQztRQUN6Qiw0RUFBNEU7UUFDbkUsa0JBQWEsR0FBRyxDQUFDLENBQUM7UUFDM0I7OztXQUdHO1FBQ00sYUFBUSxHQUFHLENBQUMsQ0FBQztRQUNiLHVCQUFrQixHQUFHLElBQUksQ0FB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LENBQUMsZUFBZSxDQUFDOytDQUd0QztBQUdEO0lBRkMsS0FBSyxFQUFFO0lBQ1AsWUFBWSxDQUFDLGVBQWUsQ0FBQzsrQ0FHN0I7QUF6RFUsaUJBQWlCO0lBckQ3QixTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsY0FBYztRQUN4QixRQUFRLEVBQUU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXFCVDtRQUNELFVBQVUsRUFBRTtZQUNWLE9BQU8sQ0FBQyxVQUFVLEVBQUU7Z0JBQ2xCLEtBQUssQ0FDSCxTQUFTLEVBQ1QsS0FBSyxDQUFDO29CQUNKLFNBQVMsRUFBRSxlQUFlO2lCQUMzQixDQUFDLENBQ0g7Z0JBQ0QsS0FBSyxDQUNILFVBQVUsRUFDVixLQUFLLENBQUM7b0JBQ0osU0FBUyxFQUFFLG1CQUFtQjtpQkFDL0IsQ0FBQyxDQUNIO2dCQUNELEtBQUssQ0FDSCxRQUFRLEVBQ1IsS0FBSyxDQUFDO29CQUNKLFNBQVMsRUFBRSxpQkFBaUI7aUJBQzdCLENBQUMsQ0FDSDtnQkFDRCxVQUFVLENBQ1IscUJBQXFCLEVBQ3JCLE9BQU8sQ0FBQywrQkFBK0IsQ0FBQyxDQUN6QzthQUNGLENBQUM7U0FDSDtRQUNELG1CQUFtQixFQUFFLEtBQUs7UUFDMUIsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07S0FDaEQsQ0FBQztJQTREYSxtQkFBQSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUE7R0EzRGxCLGlCQUFpQixDQXFON0I7U0FyTlksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgYW5pbWF0ZSxcbiAgc3RhdGUsXG4gIHN0eWxlLFxuICB0cmFuc2l0aW9uLFxuICB0cmlnZ2VyLFxufSBmcm9tICdAYW5ndWxhci9hbmltYXRpb25zJztcbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7XG4gIEFmdGVyQ29udGVudEluaXQsXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDb21wb25lbnQsXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSG9zdExpc3RlbmVyLFxuICBJbmplY3QsXG4gIElucHV0LFxuICBPbkluaXQsXG4gIE91dHB1dCxcbiAgVmlld0NoaWxkLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHNob3VsZFVwZGF0ZSBmcm9tICcuL3Nob3VsZFVwZGF0ZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25neC1oZWFkcm9vbScsXG4gIHRlbXBsYXRlOiBgXG4gIDxkaXYgW25nU3R5bGVdPVwid3JhcHBlclN0eWxlXCIgY2xhc3M9XCJoZWFkcm9vbS13cmFwcGVyIHt7IHdyYXBwZXJDbGFzc05hbWUgfX1cIlxuICAgIFtzdHlsZS5oZWlnaHQucHhdPVwid3JhcHBlckhlaWdodFwiPlxuICAgIDxkaXYgI3JlZlxuICAgICAgW0BoZWFkcm9vbV09XCJ7XG4gICAgICAgIHZhbHVlOiBzdGF0ZSxcbiAgICAgICAgcGFyYW1zOiB7XG4gICAgICAgICAgZHVyYXRpb246IGR1cmF0aW9uLFxuICAgICAgICAgIGVhc2luZzogZWFzaW5nXG4gICAgICAgIH1cbiAgICAgIH1cIlxuICAgICAgW25nU3R5bGVdPVwiaW5uZXJTdHlsZVwiXG4gICAgICBbY2xhc3NdPVwiaW5uZXJDbGFzc05hbWVcIlxuICAgICAgW2NsYXNzLmhlYWRyb29tXT1cInRydWVcIlxuICAgICAgW2NsYXNzLmhlYWRyb29tLS11bmZpeGVkXT1cInN0YXRlID09PSAndW5maXhlZCdcIlxuICAgICAgW2NsYXNzLmhlYWRyb29tLS11bnBpbm5lZF09XCJzdGF0ZSA9PT0gJ3VucGlubmVkJ1wiXG4gICAgICBbY2xhc3MuaGVhZHJvb20tLXBpbm5lZF09XCJzdGF0ZSA9PT0gJ3Bpbm5lZCdcIlxuICAgICAgW2NsYXNzLmhlYWRyb29tLS11bmZpeGVkXT1cInN0YXRlID09PSAndW5maXhlZCdcIj5cbiAgICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAgICA8L2Rpdj5cbiAgPC9kaXY+XG4gIGAsXG4gIGFuaW1hdGlvbnM6IFtcbiAgICB0cmlnZ2VyKCdoZWFkcm9vbScsIFtcbiAgICAgIHN0YXRlKFxuICAgICAgICAndW5maXhlZCcsXG4gICAgICAgIHN0eWxlKHtcbiAgICAgICAgICB0cmFuc2Zvcm06ICd0cmFuc2xhdGVZKDApJyxcbiAgICAgICAgfSksXG4gICAgICApLFxuICAgICAgc3RhdGUoXG4gICAgICAgICd1bnBpbm5lZCcsXG4gICAgICAgIHN0eWxlKHtcbiAgICAgICAgICB0cmFuc2Zvcm06ICd0cmFuc2xhdGVZKC0xMDAlKScsXG4gICAgICAgIH0pLFxuICAgICAgKSxcbiAgICAgIHN0YXRlKFxuICAgICAgICAncGlubmVkJyxcbiAgICAgICAgc3R5bGUoe1xuICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZVkoMHB4KScsXG4gICAgICAgIH0pLFxuICAgICAgKSxcbiAgICAgIHRyYW5zaXRpb24oXG4gICAgICAgICd1bnBpbm5lZCA8PT4gcGlubmVkJyxcbiAgICAgICAgYW5pbWF0ZSgne3sgZHVyYXRpb24gfX1tcyB7eyBlYXNpbmcgfX0nKSxcbiAgICAgICksXG4gICAgXSksXG4gIF0sXG4gIHByZXNlcnZlV2hpdGVzcGFjZXM6IGZhbHNlLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbn0pXG5leHBvcnQgY2xhc3MgSGVhZHJvb21Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyQ29udGVudEluaXQge1xuICBASW5wdXQoKSB3cmFwcGVyQ2xhc3NOYW1lID0gJyc7XG4gIEBJbnB1dCgpIGlubmVyQ2xhc3NOYW1lID0gJyc7XG4gIEBJbnB1dCgpIGlubmVyU3R5bGU6IGFueSA9IHtcbiAgICB0b3A6ICcwJyxcbiAgICBsZWZ0OiAnMCcsXG4gICAgcmlnaHQ6ICcwJyxcbiAgICB6SW5kZXg6ICcxJyxcbiAgICBwb3NpdGlvbjogJ3JlbGF0aXZlJyxcbiAgfTtcbiAgLyoqXG4gICAqIHBhc3Mgc3R5bGVzIGZvciB0aGUgd3JhcHBlciBkaXZcbiAgICogKHRoaXMgbWFpbnRhaW5zIHRoZSBjb21wb25lbnRzIHZlcnRpY2FsIHNwYWNlIGF0IHRoZSB0b3Agb2YgdGhlIHBhZ2UpXG4gICAqL1xuICBASW5wdXQoKSB3cmFwcGVyU3R5bGU6IGFueSA9IHt9O1xuICAvKiogZGlzYWJsZSBwaW5uaW5nIGFuZCB1bnBpbm5pbmcgKi9cbiAgQElucHV0KCkgZGlzYWJsZSA9IGZhbHNlO1xuICAvKiogc2Nyb2xsIHRvbGVyYW5jZSBpbiBweCB3aGVuIHNjcm9sbGluZyB1cCBiZWZvcmUgY29tcG9uZW50IGlzIHBpbm5lZCAqL1xuICBASW5wdXQoKSB1cFRvbGVyYW5jZSA9IDU7XG4gIC8qKiBzY3JvbGwgdG9sZXJhbmNlIGluIHB4IHdoZW4gc2Nyb2xsaW5nIGRvd24gYmVmb3JlIGNvbXBvbmVudCBpcyBwaW5uZWQgKi9cbiAgQElucHV0KCkgZG93blRvbGVyYW5jZSA9IDA7XG4gIC8qKlxuICAgKiBoZWlnaHQgaW4gcHggd2hlcmUgdGhlIGhlYWRlciBzaG91bGQgc3RhcnQgYW5kIHN0b3AgcGlubmluZy5cbiAgICogVXNlZnVsIHdoZW4geW91IGhhdmUgYW5vdGhlciBlbGVtZW50IGFib3ZlIEhlYWRyb29tXG4gICAqL1xuICBASW5wdXQoKSBwaW5TdGFydCA9IDA7XG4gIEBJbnB1dCgpIGNhbGNIZWlnaHRPblJlc2l6ZSA9IHRydWU7XG4gIC8qKiBEdXJhdGlvbiBvZiBhbmltYXRpb24gaW4gbXMgKi9cbiAgQElucHV0KCkgZHVyYXRpb24gPSAyMDA7XG4gIC8qKiBFYXNpbmcgb2YgYW5pbWF0aW9uICovXG4gIEBJbnB1dCgpIGVhc2luZyA9ICdlYXNlLWluLW91dCc7XG4gIEBPdXRwdXQoKSBwaW4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSB1bnBpbiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIHVuZml4ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAVmlld0NoaWxkKCdyZWYnLCB7IHN0YXRpYzogdHJ1ZSB9KSBpbm5lcjogRWxlbWVudFJlZjtcbiAgd3JhcHBlckhlaWdodCA9IDA7XG4gIGN1cnJlbnRTY3JvbGxZID0gMDtcbiAgbGFzdEtub3duU2Nyb2xsWSA9IDA7XG4gIHNjcm9sbGVkID0gZmFsc2U7XG4gIHJlc2l6ZVRpY2tpbmcgPSBmYWxzZTtcbiAgc3RhdGUgPSAndW5maXhlZCc7XG4gIHRyYW5zbGF0ZVkgPSAnMHB4JztcbiAgaGVpZ2h0OiBudW1iZXI7XG4gIHNjcm9sbFRpY2tpbmcgPSBmYWxzZTtcbiAgLyoqXG4gICAqIHByb3ZpZGUgYSBjdXN0b20gJ3BhcmVudCcgZWxlbWVudCBmb3Igc2Nyb2xsIGV2ZW50cy5cbiAgICogYHBhcmVudGAgc2hvdWxkIGJlIGEgZnVuY3Rpb24gd2hpY2ggcmVzb2x2ZXMgdG8gdGhlIGRlc2lyZWQgZWxlbWVudC5cbiAgICovXG4gIEBJbnB1dCgpIHBhcmVudDogKCkgPT4gYW55O1xuICBASW5wdXQoKSBASG9zdExpc3RlbmVyKCd3aW5kb3c6c2Nyb2xsJylcbiAgc2Nyb2xsKCkge1xuICAgIHRoaXMuaGFuZGxlU2Nyb2xsKCk7XG4gIH1cbiAgQElucHV0KClcbiAgQEhvc3RMaXN0ZW5lcignd2luZG93OnJlc2l6ZScpXG4gIHJlc2l6ZSgpIHtcbiAgICB0aGlzLmhhbmRsZVJlc2l6ZSgpO1xuICB9XG5cbiAgY29uc3RydWN0b3IoQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2N1bWVudDogYW55KSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuaW5uZXJTdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlWSgke3RoaXMudHJhbnNsYXRlWX0pYDtcblxuICAgIGlmICh0aGlzLmRpc2FibGUgPT09IHRydWUpIHtcbiAgICAgIHRoaXMuaGFuZGxlVW5maXgoKTtcbiAgICB9XG4gIH1cbiAgZ2V0UGFyZW50KCkge1xuICAgIGlmICh0aGlzLnBhcmVudCkge1xuICAgICAgcmV0dXJuIHRoaXMucGFyZW50KCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiB0aGlzLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3ApIHtcbiAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudDtcbiAgICB9XG4gICAgaWYgKHRoaXMuZG9jdW1lbnQuYm9keSAmJiB0aGlzLmRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wKSB7XG4gICAgICByZXR1cm4gdGhpcy5kb2N1bWVudC5ib2R5O1xuICAgIH1cbiAgICBpZiAodGhpcy5kb2N1bWVudC5ib2R5ICYmIHRoaXMuZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlLnNjcm9sbFRvcCkge1xuICAgICAgcmV0dXJuIHRoaXMuZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5kb2N1bWVudDtcbiAgfVxuICBuZ0FmdGVyQ29udGVudEluaXQoKSB7XG4gICAgdGhpcy5zZXRIZWlnaHRPZmZzZXQoKTtcbiAgICB0aGlzLndyYXBwZXJIZWlnaHQgPSB0aGlzLmhlaWdodCA/IHRoaXMuaGVpZ2h0IDogbnVsbDtcbiAgfVxuICBzZXRIZWlnaHRPZmZzZXQoKSB7XG4gICAgdGhpcy5oZWlnaHQgPSBudWxsO1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5oZWlnaHQgPSB0aGlzLmlubmVyLm5hdGl2ZUVsZW1lbnQub2Zmc2V0SGVpZ2h0O1xuICAgICAgdGhpcy5yZXNpemVUaWNraW5nID0gZmFsc2U7XG4gICAgfSwgMCk7XG4gIH1cbiAgZ2V0U2Nyb2xsWSgpIHtcbiAgICBpZiAodGhpcy5nZXRQYXJlbnQoKS5wYWdlWU9mZnNldCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRQYXJlbnQoKS5wYWdlWU9mZnNldDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZ2V0UGFyZW50KCkuc2Nyb2xsVG9wIHx8IDA7XG4gIH1cbiAgZ2V0Vmlld3BvcnRIZWlnaHQoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMuZ2V0UGFyZW50KCkuaW5uZXJIZWlnaHQgfHxcbiAgICAgIHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCB8fFxuICAgICAgdGhpcy5kb2N1bWVudC5ib2R5LmNsaWVudEhlaWdodFxuICAgICk7XG4gIH1cbiAgZ2V0RG9jdW1lbnRIZWlnaHQoKSB7XG4gICAgY29uc3QgYm9keSA9IHRoaXMuZG9jdW1lbnQuYm9keTtcbiAgICBjb25zdCBkb2N1bWVudEVsZW1lbnQgPSB0aGlzLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudDtcblxuICAgIHJldHVybiBNYXRoLm1heChcbiAgICAgIGJvZHkuc2Nyb2xsSGVpZ2h0LFxuICAgICAgZG9jdW1lbnRFbGVtZW50LnNjcm9sbEhlaWdodCxcbiAgICAgIGJvZHkub2Zmc2V0SGVpZ2h0LFxuICAgICAgZG9jdW1lbnRFbGVtZW50Lm9mZnNldEhlaWdodCxcbiAgICAgIGJvZHkuY2xpZW50SGVpZ2h0LFxuICAgICAgZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCxcbiAgICApO1xuICB9XG4gIGdldEVsZW1lbnRQaHlzaWNhbEhlaWdodChlbG06IGFueSkge1xuICAgIHJldHVybiBNYXRoLm1heChlbG0ub2Zmc2V0SGVpZ2h0LCBlbG0uY2xpZW50SGVpZ2h0KTtcbiAgfVxuICBnZXRFbGVtZW50SGVpZ2h0KGVsbTogYW55KSB7XG4gICAgcmV0dXJuIE1hdGgubWF4KGVsbS5zY3JvbGxIZWlnaHQsIGVsbS5vZmZzZXRIZWlnaHQsIGVsbS5jbGllbnRIZWlnaHQpO1xuICB9XG4gIGdldFNjcm9sbGVyUGh5c2ljYWxIZWlnaHQoKSB7XG4gICAgY29uc3QgcGFyZW50ID0gdGhpcy5nZXRQYXJlbnQoKTtcblxuICAgIHJldHVybiBwYXJlbnQgPT09IHRoaXMuZ2V0UGFyZW50KCkgfHwgcGFyZW50ID09PSB0aGlzLmRvY3VtZW50LmJvZHlcbiAgICAgID8gdGhpcy5nZXRWaWV3cG9ydEhlaWdodCgpXG4gICAgICA6IHRoaXMuZ2V0RWxlbWVudFBoeXNpY2FsSGVpZ2h0KHBhcmVudCk7XG4gIH1cbiAgZ2V0U2Nyb2xsZXJIZWlnaHQoKSB7XG4gICAgY29uc3QgcGFyZW50ID0gdGhpcy5nZXRQYXJlbnQoKTtcblxuICAgIHJldHVybiBwYXJlbnQgPT09IHRoaXMuZ2V0UGFyZW50KCkgfHwgcGFyZW50ID09PSB0aGlzLmRvY3VtZW50LmJvZHlcbiAgICAgID8gdGhpcy5nZXREb2N1bWVudEhlaWdodCgpXG4gICAgICA6IHRoaXMuZ2V0RWxlbWVudEhlaWdodChwYXJlbnQpO1xuICB9XG4gIGlzT3V0T2ZCb3VuZChjdXJyZW50U2Nyb2xsWSkge1xuICAgIGNvbnN0IHBhc3RUb3AgPSBjdXJyZW50U2Nyb2xsWSA8IDA7XG5cbiAgICBjb25zdCBzY3JvbGxlclBoeXNpY2FsSGVpZ2h0ID0gdGhpcy5nZXRTY3JvbGxlclBoeXNpY2FsSGVpZ2h0KCk7XG4gICAgY29uc3Qgc2Nyb2xsZXJIZWlnaHQgPSB0aGlzLmdldFNjcm9sbGVySGVpZ2h0KCk7XG5cbiAgICBjb25zdCBwYXN0Qm90dG9tID0gY3VycmVudFNjcm9sbFkgKyBzY3JvbGxlclBoeXNpY2FsSGVpZ2h0ID4gc2Nyb2xsZXJIZWlnaHQ7XG5cbiAgICByZXR1cm4gcGFzdFRvcCB8fCBwYXN0Qm90dG9tO1xuICB9XG4gIGhhbmRsZVNjcm9sbCgpIHtcbiAgICBpZiAodGhpcy5kaXNhYmxlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghdGhpcy5zY3JvbGxUaWNraW5nKSB7XG4gICAgICB0aGlzLnNjcm9sbFRpY2tpbmcgPSB0cnVlO1xuICAgICAgdGhpcy51cGRhdGUoKTtcbiAgICB9XG4gIH1cbiAgaGFuZGxlUmVzaXplKCkge1xuICAgIGlmICh0aGlzLmRpc2FibGUgfHwgIXRoaXMuY2FsY0hlaWdodE9uUmVzaXplKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghdGhpcy5yZXNpemVUaWNraW5nKSB7XG4gICAgICB0aGlzLnJlc2l6ZVRpY2tpbmcgPSB0cnVlO1xuICAgICAgdGhpcy5zZXRIZWlnaHRPZmZzZXQoKTtcbiAgICB9XG4gIH1cbiAgaGFuZGxlVW5waW4oKSB7XG4gICAgdGhpcy51bnBpbi5lbWl0KCk7XG4gICAgdGhpcy5zdGF0ZSA9ICd1bnBpbm5lZCc7XG4gICAgdGhpcy5pbm5lclN0eWxlLnBvc2l0aW9uID1cbiAgICAgIHRoaXMuZGlzYWJsZSB8fCB0aGlzLnN0YXRlID09PSAndW5maXhlZCcgPyAncmVsYXRpdmUnIDogJ2ZpeGVkJztcbiAgfVxuICBoYW5kbGVQaW4oKSB7XG4gICAgdGhpcy5waW4uZW1pdCgpO1xuICAgIHRoaXMuc3RhdGUgPSAncGlubmVkJztcbiAgICB0aGlzLmlubmVyU3R5bGUucG9zaXRpb24gPVxuICAgICAgdGhpcy5kaXNhYmxlIHx8IHRoaXMuc3RhdGUgPT09ICd1bmZpeGVkJyA/ICdyZWxhdGl2ZScgOiAnZml4ZWQnO1xuICB9XG4gIGhhbmRsZVVuZml4KCkge1xuICAgIHRoaXMudW5maXguZW1pdCgpO1xuICAgIHRoaXMuc3RhdGUgPSAndW5maXhlZCc7XG4gICAgdGhpcy5pbm5lclN0eWxlLnBvc2l0aW9uID1cbiAgICAgIHRoaXMuZGlzYWJsZSB8fCB0aGlzLnN0YXRlID09PSAndW5maXhlZCcgPyAncmVsYXRpdmUnIDogJ2ZpeGVkJztcbiAgfVxuICB1cGRhdGUoKSB7XG4gICAgdGhpcy5jdXJyZW50U2Nyb2xsWSA9IHRoaXMuZ2V0U2Nyb2xsWSgpO1xuXG4gICAgaWYgKCF0aGlzLmlzT3V0T2ZCb3VuZCh0aGlzLmN1cnJlbnRTY3JvbGxZKSkge1xuICAgICAgY29uc3QgeyBhY3Rpb24gfSA9IHNob3VsZFVwZGF0ZShcbiAgICAgICAgdGhpcy5sYXN0S25vd25TY3JvbGxZLFxuICAgICAgICB0aGlzLmN1cnJlbnRTY3JvbGxZLFxuICAgICAgICB0aGlzLmRpc2FibGUsXG4gICAgICAgIHRoaXMucGluU3RhcnQsXG4gICAgICAgIHRoaXMuZG93blRvbGVyYW5jZSxcbiAgICAgICAgdGhpcy51cFRvbGVyYW5jZSxcbiAgICAgICAgdGhpcy5zdGF0ZSxcbiAgICAgICAgdGhpcy5oZWlnaHQsXG4gICAgICApO1xuXG4gICAgICBpZiAoYWN0aW9uID09PSAncGluJykge1xuICAgICAgICB0aGlzLmhhbmRsZVBpbigpO1xuICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICd1bnBpbicpIHtcbiAgICAgICAgdGhpcy5oYW5kbGVVbnBpbigpO1xuICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICd1bmZpeCcpIHtcbiAgICAgICAgdGhpcy5oYW5kbGVVbmZpeCgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMubGFzdEtub3duU2Nyb2xsWSA9IHRoaXMuY3VycmVudFNjcm9sbFk7XG4gICAgdGhpcy5zY3JvbGxUaWNraW5nID0gZmFsc2U7XG4gIH1cbn1cbiJdfQ==